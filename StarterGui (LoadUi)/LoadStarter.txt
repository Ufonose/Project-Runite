-- LoadStarter (StarterGui > LoadUi > LoadStarter)
-- Modern automatic loading screen with progress tracking

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local Plr = Players.LocalPlayer
local PlayerGui = Plr:WaitForChild("PlayerGui")

-- Wait for required UI elements
script.Parent.Parent:WaitForChild("MainUi")
local LoadUi = script.Parent
local LoadModule = require(script.Parent.LoadModule)

-- Create modern loading screen
local function CreateModernLoadingScreen()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "ModernLoadingScreen"
	screenGui.DisplayOrder = 10
	screenGui.IgnoreGuiInset = true
	screenGui.ResetOnSpawn = false
	screenGui.Parent = PlayerGui

	-- Background with gradient
	local background = Instance.new("Frame")
	background.Name = "Background"
	background.Size = UDim2.new(1, 0, 1, 0)
	background.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
	background.BorderSizePixel = 0
	background.Parent = screenGui

	local gradient = Instance.new("UIGradient")
	gradient.Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 30)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 10, 15))
	}
	gradient.Rotation = 45
	gradient.Parent = background

	-- Animated particles/stars in background
	for i = 1, 15 do
		local star = Instance.new("Frame")
		star.Name = "Star"
		star.Size = UDim2.new(0, math.random(2, 4), 0, math.random(2, 4))
		star.Position = UDim2.new(math.random(), 0, math.random(), 0)
		star.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
		star.BackgroundTransparency = math.random(30, 70) / 100
		star.BorderSizePixel = 0
		star.Parent = background

		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(1, 0)
		corner.Parent = star

		-- Animate the star
		coroutine.wrap(function()
			while star.Parent do
				local newTransparency = math.random(20, 90) / 100
				TweenService:Create(star, TweenInfo.new(math.random(1, 3), Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
					BackgroundTransparency = newTransparency
				}):Play()
				wait(math.random(1, 3))
			end
		end)()
	end

	-- Main loading container (centered)
	local container = Instance.new("Frame")
	container.Name = "Container"
	container.AnchorPoint = Vector2.new(0.5, 0.5)
	container.Position = UDim2.new(0.5, 0, 0.5, 0)
	container.Size = UDim2.new(0, 500, 0, 300)
	container.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
	container.BackgroundTransparency = 0.3
	container.BorderSizePixel = 0
	container.Parent = screenGui

	-- Mobile responsive sizing
	if screenGui.AbsoluteSize.X < 900 then
		container.Size = UDim2.new(0.9, 0, 0, 280)
	end

	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 20)
	containerCorner.Parent = container

	-- Glass-morphism effect
	local blur = Instance.new("UIStroke")
	blur.Color = Color3.fromRGB(100, 100, 120)
	blur.Thickness = 1
	blur.Transparency = 0.7
	blur.Parent = container

	-- Game title/logo
	local title = Instance.new("TextLabel")
	title.Name = "Title"
	title.Size = UDim2.new(1, -40, 0, 60)
	title.Position = UDim2.new(0, 20, 0, 30)
	title.BackgroundTransparency = 1
	title.Text = "MINING TYCOON"
	title.TextColor3 = Color3.fromRGB(255, 255, 255)
	title.TextSize = 32
	title.Font = Enum.Font.GothamBold
	title.TextStrokeTransparency = 0.8
	title.Parent = container

	-- Loading status text
	local statusText = Instance.new("TextLabel")
	statusText.Name = "StatusText"
	statusText.Size = UDim2.new(1, -40, 0, 30)
	statusText.Position = UDim2.new(0, 20, 0, 110)
	statusText.BackgroundTransparency = 1
	statusText.Text = "Initializing..."
	statusText.TextColor3 = Color3.fromRGB(200, 200, 220)
	statusText.TextSize = 18
	statusText.Font = Enum.Font.Gotham
	statusText.TextXAlignment = Enum.TextXAlignment.Left
	statusText.Parent = container

	-- Progress bar background
	local progressBg = Instance.new("Frame")
	progressBg.Name = "ProgressBackground"
	progressBg.Size = UDim2.new(1, -40, 0, 8)
	progressBg.Position = UDim2.new(0, 20, 0, 160)
	progressBg.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
	progressBg.BorderSizePixel = 0
	progressBg.Parent = container

	local progressBgCorner = Instance.new("UICorner")
	progressBgCorner.CornerRadius = UDim.new(0, 4)
	progressBgCorner.Parent = progressBg

	-- Progress bar fill
	local progressFill = Instance.new("Frame")
	progressFill.Name = "ProgressFill"
	progressFill.Size = UDim2.new(0, 0, 1, 0)
	progressFill.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
	progressFill.BorderSizePixel = 0
	progressFill.Parent = progressBg

	local progressFillCorner = Instance.new("UICorner")
	progressFillCorner.CornerRadius = UDim.new(0, 4)
	progressFillCorner.Parent = progressFill

	-- Gradient on progress bar
	local progressGradient = Instance.new("UIGradient")
	progressGradient.Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 120, 255)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(120, 180, 255))
	}
	progressGradient.Parent = progressFill

	-- Percentage text
	local percentText = Instance.new("TextLabel")
	percentText.Name = "PercentText"
	percentText.Size = UDim2.new(1, -40, 0, 25)
	percentText.Position = UDim2.new(0, 20, 0, 180)
	percentText.BackgroundTransparency = 1
	percentText.Text = "0%"
	percentText.TextColor3 = Color3.fromRGB(150, 150, 170)
	percentText.TextSize = 16
	percentText.Font = Enum.Font.GothamMedium
	percentText.TextXAlignment = Enum.TextXAlignment.Right
	percentText.Parent = container

	-- Loading tips
	local tipsText = Instance.new("TextLabel")
	tipsText.Name = "TipsText"
	tipsText.Size = UDim2.new(1, -40, 0, 50)
	tipsText.Position = UDim2.new(0, 20, 0, 220)
	tipsText.BackgroundTransparency = 1
	tipsText.Text = "Tip: Upgrade your conveyors for faster ore processing!"
	tipsText.TextColor3 = Color3.fromRGB(180, 180, 200)
	tipsText.TextSize = 14
	tipsText.Font = Enum.Font.Gotham
	tipsText.TextWrapped = true
	tipsText.TextTransparency = 0.5
	tipsText.Parent = container

	-- Rotate tips
	local tips = {
		"Tip: Research unlocks powerful automation upgrades!",
		"Tip: Cave barriers can be unlocked with research tokens!",
		"Tip: Merge conveyors combine multiple ore streams!",
		"Tip: Sorting conveyors help organize your production!",
		"Tip: Build vertically to save plot space!",
		"Tip: Hotspots yield rare gems and valuable ores!",
	}

	coroutine.wrap(function()
		local tipIndex = 1
		while tipsText.Parent do
			wait(4)
			if tipsText.Parent then
				TweenService:Create(tipsText, TweenInfo.new(0.3), {TextTransparency = 1}):Play()
				wait(0.3)
				tipIndex = (tipIndex % #tips) + 1
				tipsText.Text = tips[tipIndex]
				TweenService:Create(tipsText, TweenInfo.new(0.3), {TextTransparency = 0.5}):Play()
			end
		end
	end)()

	-- Animate container entrance
	container.Size = UDim2.new(0, 0, 0, 0)
	TweenService:Create(container, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Size = screenGui.AbsoluteSize.X < 900 and UDim2.new(0.9, 0, 0, 280) or UDim2.new(0, 500, 0, 300)
	}):Play()

	return screenGui, statusText, progressFill, percentText
end

-- Update loading progress
local function UpdateProgress(statusText, progressFill, percentText, progress, status)
	statusText.Text = status
	percentText.Text = math.floor(progress) .. "%"

	TweenService:Create(progressFill, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		Size = UDim2.new(progress / 100, 0, 1, 0)
	}):Play()
end

-- Main loading sequence
local function StartLoadingSequence()
	local loadingScreen, statusText, progressFill, percentText = CreateModernLoadingScreen()
	local title = loadingScreen.Container.Title
	local tipsText = loadingScreen.Container.TipsText

	-- Phase 1: Initialize (0-10%)
	UpdateProgress(statusText, progressFill, percentText, 5, "Connecting to server...")
	wait(0.3)

	-- Phase 2: Load player data (10-40%)
	UpdateProgress(statusText, progressFill, percentText, 10, "Loading player data...")

	-- Automatically start loading data (no button press needed)
	local loadSuccess = LoadModule.AUTO_LOAD()

	if not loadSuccess then
		statusText.Text = "Failed to load data. Please rejoin."
		statusText.TextColor3 = Color3.fromRGB(255, 100, 100)
		return
	end

	UpdateProgress(statusText, progressFill, percentText, 40, "Player data loaded!")
	wait(0.2)

	-- Phase 3: Wait for modules to load (40-70%)
	UpdateProgress(statusText, progressFill, percentText, 45, "Loading game modules...")

	-- Enable MainUi and ModuleLoader
	script.Parent.Parent.MainUi.Enabled = true
	script.Parent.Parent.MainUi.Scripts.ModuleLoader.Disabled = false

	-- Monitor module loading progress
	local moduleLoader = script.Parent.Parent.MainUi.Scripts.ModuleLoader
	local modulesLoading = script.Parent.Parent.MainUi.ModulesLoading

	-- Wait for modules to finish loading
	local startTick = tick()
	local maxWait = 10 -- Maximum 10 seconds for module loading

	while modulesLoading.Visible and (tick() - startTick) < maxWait do
		-- Update progress based on module progress text
		local progressMatch = modulesLoading.Progress.Text:match("(%d+)/100%%")
		if progressMatch then
			local moduleProgress = tonumber(progressMatch)
			-- Map module progress (0-100) to our range (45-70)
			local overallProgress = 45 + (moduleProgress * 0.25)
			UpdateProgress(statusText, progressFill, percentText, overallProgress, "Loading modules...")
		end
		wait(0.1)
	end

	UpdateProgress(statusText, progressFill, percentText, 70, "Modules loaded!")
	wait(0.2)

	-- Phase 4: Prepare plot items (70-90%)
	UpdateProgress(statusText, progressFill, percentText, 75, "Preparing your plot...")

	-- Wait a moment for any remaining plot items to load
	wait(0.5)

	UpdateProgress(statusText, progressFill, percentText, 90, "Finalizing...")
	wait(0.3)

	-- Phase 5: Complete (90-100%)
	UpdateProgress(statusText, progressFill, percentText, 100, "Done!")
	wait(0.5)

	-- Fade out loading screen
	local container = loadingScreen.Container

	-- Tween all text elements to transparent
	TweenService:Create(title, TweenInfo.new(0.5), {
		TextTransparency = 1,
		TextStrokeTransparency = 1
	}):Play()

	TweenService:Create(statusText, TweenInfo.new(0.5), {
		TextTransparency = 1
	}):Play()

	TweenService:Create(percentText, TweenInfo.new(0.5), {
		TextTransparency = 1
	}):Play()

	TweenService:Create(tipsText, TweenInfo.new(0.5), {
		TextTransparency = 1
	}):Play()

	-- Tween progress bar out
	TweenService:Create(progressFill, TweenInfo.new(0.5), {
		BackgroundTransparency = 1
	}):Play()

	TweenService:Create(progressFill.Parent, TweenInfo.new(0.5), {
		BackgroundTransparency = 1
	}):Play()

	-- Tween container size
	TweenService:Create(container, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
		Size = UDim2.new(0, 0, 0, 0)
	}):Play()

	-- Tween background
	TweenService:Create(loadingScreen.Background, TweenInfo.new(0.5), {
		BackgroundTransparency = 1
	}):Play()

	wait(0.6)
	loadingScreen:Destroy()

	-- Clean up old LoadUi
	LoadUi:Destroy()
end

-- Start the loading sequence immediately
coroutine.wrap(StartLoadingSequence)()
