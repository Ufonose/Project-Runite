local module = {}

local function tween(Object, Properties, Value, Time, Style, Direction)
	Style = Style or Enum.EasingStyle.Quad
	Direction = Direction or Enum.EasingDirection.Out

	Time = Time or 0.5

	local propertyGoals = {}

	local Table = (type(Value) == "table" and true) or false

	for i,Property in pairs(Properties) do
		propertyGoals[Property] = Table and Value[i] or Value
	end
	local tweenInfo = TweenInfo.new(
		Time,
		Style,
		Direction
	)
	local tween = game:GetService("TweenService"):Create(Object,tweenInfo,propertyGoals)
	tween:Play()
end

local function PosAnim(GuiElement, PosEnd, Time)		-- Gui Pos Animation
	tween(GuiElement, {"Position"}, PosEnd, Time)
end

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local RepStorage = SERVICES["ReplicatedStorage"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local Main = MODULES["Main"]
	local ModernPlacementMenu = MODULES["ModernPlacementMenu"]
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	local Mouse = Plr:GetMouse()
	-- Variables
	-- Booleans
	local DB = true

	-- Get the MainUi (parent of PlacementMenu script)
	local mainUi = script.Parent.Parent

	-- Hide old PlacementMenu Frame (NOT the script parent)
	for _, child in pairs(script.Parent:GetChildren()) do
		if child:IsA("GuiObject") then
			child.Visible = false
		end
	end

	-- Create modern placement menu
	local modernMenu = ModernPlacementMenu.CREATE_MODERN_PLACEMENT_MENU(mainUi)

	-- Store reference to current placing item for inventory updates
	local currentPlacingItemId = nil

	-- Function to update inventory count display
	local function updateInventoryCount()
		if not currentPlacingItemId then return end

		local success, inventory = pcall(function()
			return RepStorage.Events.GetInventoryType:InvokeServer("Items")
		end)

		if success and inventory and inventory[currentPlacingItemId] then
			local amount = inventory[currentPlacingItemId].Amount or 0
			modernMenu.InventoryLabel.Text = "Inventory: " .. amount

			-- Change color based on amount (green if has items, red if empty)
			if amount > 0 then
				modernMenu.InventoryLabel.TextColor3 = Color3.fromRGB(100, 255, 150)  -- Green
			else
				modernMenu.InventoryLabel.TextColor3 = Color3.fromRGB(255, 100, 100)  -- Red
			end
		end
	end

	-- Listen for inventory updates
	RepStorage.Events.InventoryUpdate.OnClientEvent:Connect(function()
		if modernMenu.Container.Visible then
			updateInventoryCount()
		end
	end)

	-- HIDE/REMOVE the instruction label (this is the duplicate text!)
	local instructionLabel = mainUi:FindFirstChild("PlacementInstructions")
	if instructionLabel then
		instructionLabel:Destroy()  -- Remove it completely
	end

	-- Also check for old instruction label in PlacementMenu
	local oldInstructions = script.Parent:FindFirstChild("Instructions")
	if oldInstructions then
		oldInstructions:Destroy()
	end

	function module.LOAD_MENU()
		-- Set initial position off-screen (scale-based)
		if not modernMenu.Container.Visible then
			modernMenu.Container.Position = UDim2.new(0.5, 0, 1.02, 0)  -- Off-screen below
		end

		-- Get the item being placed and update the header
		local placingItems = Plr.SetPlot.Value.PlacingItems:GetChildren()
		if #placingItems > 0 then
			local firstItem = placingItems[1]

			-- Update item name
			modernMenu.ItemNameLabel.Text = firstItem.Name

			-- Get the item's ID and store it for inventory updates
			if firstItem:FindFirstChild("ItemStats") then
				local itemInfo = require(firstItem.ItemStats)
				currentPlacingItemId = itemInfo.ItemId

				-- Update inventory count
				updateInventoryCount()
			end
		end

		-- Show and animate menu sliding up (scale-based - flush with bottom)
		modernMenu.Container.Visible = true
		PosAnim(modernMenu.Container, UDim2.new(0.5, 0, 0.98, 0), 0.3)
	end

	function module.UNLOAD_MENU()
		-- Clear current placing item reference
		currentPlacingItemId = nil

		-- Animate menu sliding down (scale-based)
		if modernMenu.Container.Visible then
			modernMenu.Container.Position = UDim2.new(0.5, 0, 1, 0)  -- Current position
		end
		PosAnim(modernMenu.Container, UDim2.new(0.5, 0, 1.2, 0), 0.3)  -- Off-screen below
		wait(0.3)
		modernMenu.Container.Visible = false
	end

	-- Store modern menu for external access
	module.ModernMenu = modernMenu
end

return module
