-- StarterGui/MainUi/Options/Options.lua (FIXED - PROPER MENU CLOSING)

local module = {}

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local RepStorage = SERVICES["ReplicatedStorage"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local Main = MODULES["Main"]
	local ModernOptions = MODULES["ModernOptions"]
	local SoundManager = require(RepStorage.Modules.SoundManager)
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	local PlayerGui = Plr:WaitForChild("PlayerGui")

	-- Hide old Options GUI elements (keep the script but hide the frames)
	for _, child in pairs(script.Parent:GetChildren()) do
		if child:IsA("GuiObject") then
			child.Visible = false
		end
	end

	-- Create modern options UI
	local modernUI = ModernOptions.CREATE_MODERN_OPTIONS_UI(script.Parent.Parent)

	-- Function to update Active Research Display visibility
	local function updateResearchDisplay()
		local activeResearchDisplay = PlayerGui:FindFirstChild("ActiveResearchDisplay")
		if activeResearchDisplay then
			local hideResearch = Plr.Settings:FindFirstChild("HideResearch")
			if hideResearch then
				-- If HideResearch is true, hide the display. If false, show it.
				activeResearchDisplay.Enabled = not hideResearch.Value

				-- IMPORTANT: Set DisplayOrder to keep it behind other GUIs
				-- This prevents it from appearing on top when re-enabled
				activeResearchDisplay.DisplayOrder = -1
			end
		end
	end

	-- Set up Active Research Display toggle
	local hideResearchSetting = Plr.Settings:FindFirstChild("HideResearch")
	if hideResearchSetting then
		-- Initial update
		updateResearchDisplay()

		-- Listen for changes
		hideResearchSetting.Changed:Connect(updateResearchDisplay)
	end

	-- Clear ores button functionality
	modernUI.ClearOresButton.MouseButton1Click:Connect(function()
		SoundManager.ButtonClick()
		local success = RepStorage.Events.ClearPlotOres:InvokeServer()
		if success then
			print("Plot ores cleared successfully!")
		else
			warn("Failed to clear plot ores")
		end
	end)

	-- Withdraw button functionality (show confirmation popup)
	modernUI.WithdrawButton.MouseButton1Click:Connect(function()
		SoundManager.ButtonClick()
		modernUI.ConfirmationPopup.Visible = true
	end)

	-- Confirmation popup - Yes button
	modernUI.YesButton.MouseButton1Click:Connect(function()
		SoundManager.ButtonClick()
		modernUI.ConfirmationPopup.Visible = false
		local success = RepStorage.Events.WithdrawAllItems:InvokeServer()
		if success then
			print("All items withdrawn successfully!")
		else
			warn("Failed to withdraw items")
		end
	end)

	-- Confirmation popup - No button
	modernUI.NoButton.MouseButton1Click:Connect(function()
		SoundManager.ButtonClick()
		modernUI.ConfirmationPopup.Visible = false
	end)

	-- Menu toggle handler (this handles the visual state)
	script.Parent.MenuObject.Changed:Connect(function()
		if script.Parent.MenuObject.Value then
			-- Opening settings
			modernUI.Container.Visible = true
			print("Settings opened")
		else
			-- Closing settings
			modernUI.Container.Visible = false
			modernUI.ConfirmationPopup.Visible = false  -- Also hide popup
			print("Settings closed")
		end
	end)

	-- Close button handler (FIXED - uses Main.CLOSE_MENU like all other GUIs)
	modernUI.CloseButton.MouseButton1Click:Connect(function()
		Main.CLOSE_MENU(script.Parent)
	end)

	print("Modern Options GUI loaded successfully!")
end

return module
