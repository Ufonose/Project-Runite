local module = {}

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local RepStorage = SERVICES["ReplicatedStorage"]
	local RunService = SERVICES["RunService"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local MainLib = MODULES["MainLib"]
	local Main = MODULES["Main"]
	local ModernItemHover = MODULES["ModernItemHover"]
	-- Plr Info
	local Camera = workspace.CurrentCamera
	local Plr = Plrs.LocalPlayer
	local Mouse = Plr:GetMouse()
	-- Variables
	local DB = true

	-- Hide old ItemHover GUI
	script.Parent.Visible = false

	-- Create modern hover UI
	local modernHover = ModernItemHover.CREATE_MODERN_HOVER_UI(script.Parent.Parent)
	modernHover.Hide()

	-- Button hovering (for shop/inventory buttons)
	script.Parent.ButtonHovering.Changed:Connect(function()
		local BUTTON = script.Parent.ButtonHovering.Value
		if BUTTON ~= nil then
			local REAL_ITEM = RepStorage.Items:FindFirstChild(BUTTON:GetAttribute("ITEM_NAME"))
			if not REAL_ITEM then return end

			local ITEM_INFO = require(REAL_ITEM.ItemStats)
			local TIER_NAME, TIER_INFO = MainLib.GET_ITEM_TIER_INFO(REAL_ITEM.Name)

			modernHover.ItemTier.TextColor3 = TIER_INFO["TIER_COLOR"]
			modernHover.ItemTier.Text = TIER_NAME
			modernHover.ItemName.Text = REAL_ITEM.Name

			-- Check if item is locked and show unlock requirement
			local isUnlocked = BUTTON:GetAttribute("IS_UNLOCKED")
			local descText = ITEM_INFO.Description

			if isUnlocked == false then
				local unlockResearch = RepStorage.Events.GetItemUnlockRequirement:InvokeServer(ITEM_INFO.ItemId)
				if unlockResearch then
					descText = "ðŸ”’ LOCKED\nComplete: " .. unlockResearch.Name .. "\n\n" .. ITEM_INFO.Description
				else
					descText = "ðŸ”’ LOCKED\n\n" .. ITEM_INFO.Description
				end
			end

			-- Show expanded view for buttons (in menus)
			modernHover.ShowExpanded(descText)
			modernHover.Show()
		else
			modernHover.Hide()
		end
	end)

	function module.UPDATE_HOVER()
		if not modernHover.Container.Visible then return end

		-- Check if we're hovering over a placed item using ObjectValue reference
		local hoveredItemRef = script.Parent:FindFirstChild("HoveredItemRef")
		if hoveredItemRef and hoveredItemRef.Value then
			local placedItem = hoveredItemRef.Value
			if placedItem and placedItem.Parent and placedItem:FindFirstChild("Hitbox") then
				-- Position above the item
				local hitbox = placedItem.Hitbox
				local worldPos = hitbox.Position + Vector3.new(0, hitbox.Size.Y/2 + 0.5, 0)
				local screenPos, onScreen = Camera:WorldToScreenPoint(worldPos)

				if onScreen then
					local tooltipX = screenPos.X - modernHover.Container.AbsoluteSize.X/2
					local tooltipY = screenPos.Y - modernHover.Container.AbsoluteSize.Y + 100
					modernHover.Container.Position = UDim2.new(0, tooltipX, 0, tooltipY)
				end
				return -- Don't use mouse positioning
			end
		end

		-- Original mouse positioning for buttons
		local MOUSE_X = Mouse.X + 25
		local MOUSE_Y = Mouse.Y + 15
		if Mouse.X > Camera.ViewportSize.X/2 then
			MOUSE_X = Mouse.X - modernHover.Container.AbsoluteSize.X - 15
		end
		if Mouse.Y > Camera.ViewportSize.Y/1.3 then
			MOUSE_Y = Mouse.Y - modernHover.Container.AbsoluteSize.Y - 15
		end
		modernHover.Container.Position = UDim2.new(0, MOUSE_X, 0, MOUSE_Y)
	end

	-- Update tooltip position every frame for placed items
	RunService.RenderStepped:Connect(function()
		local hoveredItemRef = script.Parent:FindFirstChild("HoveredItemRef")
		local modernSelectionOpen = script.Parent.Parent:FindFirstChild("ModernSelected") 
			and script.Parent.Parent.ModernSelected.Visible

		-- Only update position if tooltip is visible, item is hovered, and selection menu is NOT open
		if modernHover.Container.Visible and hoveredItemRef and hoveredItemRef.Value and not modernSelectionOpen then
			module.UPDATE_HOVER()
		end
	end)

	-- Expose modern hover to be used by ItemSelection
	module.ModernHover = modernHover
end

return module
