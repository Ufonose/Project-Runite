-- StarterGui/MainUi/Main.lua (UPDATED - ONLY ONE MENU OPEN AT A TIME)

local module = {}

function module.CLOSE_MENU()
	warn("Main.CLOSE_MENU() HASN'T LOADED YET!")
end

function module.OPEN_MENU()
	warn("Main.OPEN_MENU() HASN'T LOADED YET!")
end

function module.LOAD_PAGE()
	warn("Main.LOAD_PAGE() HASN'T LOADED YET!")
end

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local RepStorage = SERVICES["ReplicatedStorage"]
	local RunService = SERVICES["RunService"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local ITEM_SELECTION = MODULES["ItemSelection"]
	local ITEM_HOVER = MODULES["ItemHover"]
	local PLACEMENT = MODULES["Placement"]
	local INPUT = MODULES["Input"]
	local SoundManager = require(RepStorage.Modules.SoundManager)
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	local Mouse = Plr:GetMouse()
	-- Variables
	-- Booleans
	local DB = true

	-- Menu Opening/Closing Handling
	function module.CLOSE_MENU(MENU_OBJ)
		local mainUi = script.Parent.Parent

		if mainUi.ItemHover.ButtonHovering.Value ~= nil and mainUi.ItemHover.ButtonHovering.Value:IsDescendantOf(MENU_OBJ) then
			mainUi.ItemHover.Visible = false
		end

		local MENU_OPENED = mainUi.Values.OpenedMenus:FindFirstChild(MENU_OBJ.Name)
		if MENU_OPENED then
			MENU_OPENED:Destroy()
			if MENU_OBJ:FindFirstChild("MenuObject") then
				MENU_OBJ.MenuObject.Value = false
			end

			-- Only set Visible if the object has this property (Frames have it, ScreenGuis don't)
			if MENU_OBJ:IsA("Frame") or MENU_OBJ:IsA("ScrollingFrame") then
				MENU_OBJ.Visible = false
			end

			-- Play close sound
			SoundManager.MenuClose()
		end
	end

	function module.OPEN_MENU(MENU_OBJ)
		local mainUi = script.Parent.Parent

		ITEM_SELECTION.UNSELECT_ITEMS()		-- Wipe the selected items before anything.

		local MENU_OPENED = mainUi.Values.OpenedMenus:FindFirstChild(MENU_OBJ.Name)
		if MENU_OPENED then
			module.CLOSE_MENU(MENU_OBJ)
		else
			-- Close ALL currently opened menus (no exceptions - only one menu open at a time)
			for I, OPENED in pairs(mainUi.Values.OpenedMenus:GetChildren()) do
				module.CLOSE_MENU(OPENED.Value)
			end

			-- Open the new menu
			local OPENED_TAG = Instance.new("ObjectValue", mainUi.Values.OpenedMenus)
			OPENED_TAG.Name = MENU_OBJ.Name
			OPENED_TAG.Value = MENU_OBJ
			if MENU_OBJ:FindFirstChild("MenuObject") then
				MENU_OBJ.MenuObject.Value = true
			end
			MENU_OBJ.Visible = true

			-- Play open sound
			SoundManager.MenuOpen()
		end
	end

	function module.LOAD_PAGE(PAGES, PAGE_NAME)
		local REAL_PAGE = nil
		for I, PAGE in pairs(PAGES:GetChildren()) do
			if PAGE:IsA("Frame") then
				if PAGE.Name == PAGE_NAME then
					PAGE.Visible = true
					REAL_PAGE = PAGE
				else
					PAGE.Visible = false
				end
			end
		end
		if REAL_PAGE == nil then
			warn(PAGE_NAME.." DOESN'T EXIST!")
		end
		return REAL_PAGE
	end

	-- Frame Update Stuff
	RunService.RenderStepped:Connect(function()
		-- Process pretty much all the Frame-Update stuff here for performance reasons.
		ITEM_HOVER.UPDATE_HOVER()
		ITEM_SELECTION.ITEM_DETECT()
		if INPUT.MOUSE_DOWN then
			if PLACEMENT.PLACING_ITEMS  then
				if DB then
					DB = false
					PLACEMENT.PLACE_ITEM()
					wait(.2)
					DB = true
				end
			end
		end
	end)
end

return module
