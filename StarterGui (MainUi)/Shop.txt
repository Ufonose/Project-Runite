local module = {}

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local RepStorage = SERVICES["ReplicatedStorage"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local PLACEMENT = MODULES["Placement"]
	local CASH_LIB = MODULES["CashLib"]
	local Main = MODULES["Main"]
	local SoundManager = require(RepStorage.Modules.SoundManager)
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	-- Variables
	local DB = true
	local AMOUNT = 1
	local CURRENT_COST = 0
	local CURRENT_TAB = "AllTab"
	local SELECTED_ITEM
	local INV
	local LOAD_SHOP  -- Forward declaration

	-- Create main shop frame with modern styling
	local shopFrame = Instance.new("Frame")
	shopFrame.Name = "ShopFrame"
	shopFrame.Size = UDim2.new(0, 560, 0, 900)
	shopFrame.Position = UDim2.new(1, -5, 1, -5)
	shopFrame.AnchorPoint = Vector2.new(1, 1)
	shopFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
	shopFrame.BackgroundTransparency = 0.1
	shopFrame.BorderSizePixel = 0
	shopFrame.Visible = false
	shopFrame.ZIndex = 5
	shopFrame.Parent = script.Parent

	-- Blur/Glass effect background
	local blur = Instance.new("Frame")
	blur.Size = UDim2.new(1, 0, 1, 0)
	blur.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
	blur.BackgroundTransparency = 0.3
	blur.BorderSizePixel = 0
	blur.ZIndex = 6
	blur.Parent = shopFrame

	local blurCorner = Instance.new("UICorner")
	blurCorner.CornerRadius = UDim.new(0, 15)
	blurCorner.Parent = blur

	-- Outer glow/shadow
	local stroke = Instance.new("UIStroke")
	stroke.Color = Color3.fromRGB(60, 60, 80)
	stroke.Thickness = 2
	stroke.Transparency = 0.5
	stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	stroke.Parent = shopFrame

	local shopCorner = Instance.new("UICorner")
	shopCorner.CornerRadius = UDim.new(0, 15)
	shopCorner.Parent = shopFrame

	-- Title bar with modern styling
	local titleBar = Instance.new("Frame")
	titleBar.Name = "TitleBar"
	titleBar.Size = UDim2.new(1, 0, 0, 50)
	titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	titleBar.BorderSizePixel = 0
	titleBar.ZIndex = 7
	titleBar.Parent = shopFrame

	local titleCorner = Instance.new("UICorner")
	titleCorner.CornerRadius = UDim.new(0, 15)
	titleCorner.Parent = titleBar

	-- Cover for bottom of title bar
	local titleCover = Instance.new("Frame")
	titleCover.Size = UDim2.new(1, 0, 0, 15)
	titleCover.Position = UDim2.new(0, 0, 1, -15)
	titleCover.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	titleCover.BorderSizePixel = 0
	titleCover.ZIndex = 7
	titleCover.Parent = titleBar

	-- Title text (centered)
	local titleText = Instance.new("TextLabel")
	titleText.Size = UDim2.new(1, -120, 1, 0)
	titleText.Position = UDim2.new(0, 60, 0, 0)
	titleText.BackgroundTransparency = 1
	titleText.Text = "ðŸ›’ Shop"
	titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
	titleText.TextSize = 28
	titleText.Font = Enum.Font.GothamBold
	titleText.TextXAlignment = Enum.TextXAlignment.Center
	titleText.ZIndex = 8
	titleText.Parent = titleBar

	-- Close button with modern styling
	local closeButton = Instance.new("TextButton")
	closeButton.Size = UDim2.new(0, 40, 0, 40)
	closeButton.Position = UDim2.new(1, -45, 0, 5)
	closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
	closeButton.BackgroundTransparency = 0
	closeButton.Text = "X"
	closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	closeButton.TextSize = 22
	closeButton.Font = Enum.Font.GothamBold
	closeButton.ZIndex = 8
	closeButton.Parent = titleBar

	local closeCorner = Instance.new("UICorner")
	closeCorner.CornerRadius = UDim.new(0, 10)
	closeCorner.Parent = closeButton

	-- Close button stroke
	local closeStroke = Instance.new("UIStroke")
	closeStroke.Color = Color3.fromRGB(0, 0, 0)
	closeStroke.Thickness = 1
	closeStroke.Transparency = 0.7
	closeStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	closeStroke.Parent = closeButton

	closeButton.MouseButton1Click:Connect(function()
		Main.CLOSE_MENU(script.Parent)
		shopFrame.Visible = false
	end)

	-- Category and search bar frame
	local topFrame = Instance.new("Frame")
	topFrame.Size = UDim2.new(1, -40, 0, 80)
	topFrame.Position = UDim2.new(0, 20, 0, 60)
	topFrame.BackgroundTransparency = 1
	topFrame.ZIndex = 7
	topFrame.Parent = shopFrame

	-- Search bar with modern styling (full width on top)
	local searchFrame = Instance.new("Frame")
	searchFrame.Size = UDim2.new(1, 0, 0, 35)
	searchFrame.Position = UDim2.new(0, 0, 0, 0)
	searchFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
	searchFrame.BorderSizePixel = 0
	searchFrame.ZIndex = 8
	searchFrame.Parent = topFrame

	local searchCorner = Instance.new("UICorner")
	searchCorner.CornerRadius = UDim.new(0, 10)
	searchCorner.Parent = searchFrame

	-- Search frame stroke
	local searchStroke = Instance.new("UIStroke")
	searchStroke.Color = Color3.fromRGB(60, 60, 80)
	searchStroke.Thickness = 1
	searchStroke.Transparency = 0.6
	searchStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	searchStroke.Parent = searchFrame

	local searchIcon = Instance.new("TextLabel")
	searchIcon.Size = UDim2.new(0, 30, 1, 0)
	searchIcon.Position = UDim2.new(0, 10, 0, 0)
	searchIcon.BackgroundTransparency = 1
	searchIcon.Text = "ðŸ”"
	searchIcon.TextSize = 16
	searchIcon.ZIndex = 9
	searchIcon.Parent = searchFrame

	local searchBox = Instance.new("TextBox")
	searchBox.Size = UDim2.new(1, -80, 1, 0)
	searchBox.Position = UDim2.new(0, 40, 0, 0)
	searchBox.BackgroundTransparency = 1
	searchBox.Text = ""
	searchBox.PlaceholderText = "Search..."
	searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
	searchBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
	searchBox.TextSize = 13
	searchBox.Font = Enum.Font.Gotham
	searchBox.TextXAlignment = Enum.TextXAlignment.Left
	searchBox.ClearTextOnFocus = false
	searchBox.ZIndex = 9
	searchBox.Parent = searchFrame

	local clearButton = Instance.new("TextButton")
	clearButton.Size = UDim2.new(0, 28, 0, 28)
	clearButton.Position = UDim2.new(1, -32, 0.5, -14)
	clearButton.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
	clearButton.Text = "X"
	clearButton.TextColor3 = Color3.fromRGB(200, 200, 200)
	clearButton.TextSize = 14
	clearButton.Font = Enum.Font.GothamBold
	clearButton.Visible = false
	clearButton.ZIndex = 9
	clearButton.Parent = searchFrame

	local clearCorner = Instance.new("UICorner")
	clearCorner.CornerRadius = UDim.new(1, 0)
	clearCorner.Parent = clearButton

	clearButton.MouseButton1Click:Connect(function()
		searchBox.Text = ""
	end)

	-- Category buttons container (all in one row)
	local categoryFrame = Instance.new("Frame")
	categoryFrame.Size = UDim2.new(1, 0, 0, 35)
	categoryFrame.Position = UDim2.new(0, 0, 0, 45)
	categoryFrame.BackgroundTransparency = 1
	categoryFrame.ZIndex = 7
	categoryFrame.Parent = topFrame

	local categoryLayout = Instance.new("UIListLayout")
	categoryLayout.FillDirection = Enum.FillDirection.Horizontal
	categoryLayout.Padding = UDim.new(0, 8)
	categoryLayout.SortOrder = Enum.SortOrder.LayoutOrder
	categoryLayout.Parent = categoryFrame

	-- "All" button with modern styling (now part of category row)
	local allButton = Instance.new("TextButton")
	allButton.Name = "AllTab"
	allButton.Size = UDim2.new(0, 110, 0, 35)
	allButton.BackgroundColor3 = Color3.fromRGB(100, 70, 140)
	allButton.BackgroundTransparency = 0
	allButton.Text = "ðŸ“¦ All"
	allButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	allButton.TextSize = 14
	allButton.Font = Enum.Font.GothamBold
	allButton.LayoutOrder = 0
	allButton.ZIndex = 8
	allButton.Parent = categoryFrame

	local allCorner = Instance.new("UICorner")
	allCorner.CornerRadius = UDim.new(0, 10)
	allCorner.Parent = allButton

	-- All button stroke
	local allStroke = Instance.new("UIStroke")
	allStroke.Color = Color3.fromRGB(0, 0, 0)
	allStroke.Thickness = 1
	allStroke.Transparency = 0.7
	allStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	allStroke.Parent = allButton

	-- Items scroll frame with modern styling
	local itemsScroll = Instance.new("ScrollingFrame")
	itemsScroll.Name = "ItemsScroll"
	itemsScroll.Size = UDim2.new(1, -40, 1, -345)
	itemsScroll.Position = UDim2.new(0, 20, 0, 155)
	itemsScroll.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
	itemsScroll.BackgroundTransparency = 0.3
	itemsScroll.BorderSizePixel = 0
	itemsScroll.ScrollBarThickness = 10
	itemsScroll.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 105)
	itemsScroll.ZIndex = 7
	itemsScroll.Parent = shopFrame

	local itemsCorner = Instance.new("UICorner")
	itemsCorner.CornerRadius = UDim.new(0, 12)
	itemsCorner.Parent = itemsScroll

	-- Items scroll stroke
	local itemsStroke = Instance.new("UIStroke")
	itemsStroke.Color = Color3.fromRGB(60, 60, 80)
	itemsStroke.Thickness = 1
	itemsStroke.Transparency = 0.6
	itemsStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	itemsStroke.Parent = itemsScroll

	local itemsGrid = Instance.new("UIGridLayout")
	itemsGrid.CellSize = UDim2.new(0, 155, 0, 210)
	itemsGrid.CellPadding = UDim2.new(0, 10, 0, 10)
	itemsGrid.SortOrder = Enum.SortOrder.LayoutOrder
	itemsGrid.Parent = itemsScroll

	local itemsPadding = Instance.new("UIPadding")
	itemsPadding.PaddingTop = UDim.new(0, 15)
	itemsPadding.PaddingBottom = UDim.new(0, 15)
	itemsPadding.PaddingLeft = UDim.new(0, 15)
	itemsPadding.PaddingRight = UDim.new(0, 15)
	itemsPadding.Parent = itemsScroll

	-- Selected item panel with modern styling
	local selectedPanel = Instance.new("Frame")
	selectedPanel.Name = "SelectedPanel"
	selectedPanel.Size = UDim2.new(1, -40, 0, 170)
	selectedPanel.Position = UDim2.new(0, 20, 1, -185)
	selectedPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
	selectedPanel.BackgroundTransparency = 0.2
	selectedPanel.BorderSizePixel = 0
	selectedPanel.Visible = false
	selectedPanel.ZIndex = 7
	selectedPanel.Parent = shopFrame

	local selectedCorner = Instance.new("UICorner")
	selectedCorner.CornerRadius = UDim.new(0, 12)
	selectedCorner.Parent = selectedPanel

	-- Selected panel stroke
	local selectedStroke = Instance.new("UIStroke")
	selectedStroke.Color = Color3.fromRGB(60, 60, 80)
	selectedStroke.Thickness = 2
	selectedStroke.Transparency = 0.5
	selectedStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	selectedStroke.Parent = selectedPanel

	-- Selected item icon
	local selectedIcon = Instance.new("ImageLabel")
	selectedIcon.Size = UDim2.new(0, 150, 0, 150)
	selectedIcon.Position = UDim2.new(0, 10, 0, 10)
	selectedIcon.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
	selectedIcon.BorderSizePixel = 0
	selectedIcon.ZIndex = 8
	selectedIcon.Parent = selectedPanel

	local selectedIconCorner = Instance.new("UICorner")
	selectedIconCorner.CornerRadius = UDim.new(0, 12)
	selectedIconCorner.Parent = selectedIcon

	-- Selected item info container (everything to the right of image)
	local infoContainer = Instance.new("Frame")
	infoContainer.Size = UDim2.new(1, -180, 1, -20)
	infoContainer.Position = UDim2.new(0, 170, 0, 10)
	infoContainer.BackgroundTransparency = 1
	infoContainer.ZIndex = 8
	infoContainer.Parent = selectedPanel

	-- Selected item name
	local selectedName = Instance.new("TextLabel")
	selectedName.Size = UDim2.new(1, 0, 0, 22)
	selectedName.Position = UDim2.new(0, 0, 0, 0)
	selectedName.BackgroundTransparency = 1
	selectedName.Text = "Item Name"
	selectedName.TextColor3 = Color3.fromRGB(255, 255, 255)
	selectedName.TextSize = 16
	selectedName.Font = Enum.Font.GothamBold
	selectedName.TextXAlignment = Enum.TextXAlignment.Left
	selectedName.TextTruncate = Enum.TextTruncate.AtEnd
	selectedName.ZIndex = 9
	selectedName.Parent = infoContainer

	-- Selected item tier
	local selectedTier = Instance.new("TextLabel")
	selectedTier.Size = UDim2.new(1, 0, 0, 16)
	selectedTier.Position = UDim2.new(0, 0, 0, 24)
	selectedTier.BackgroundTransparency = 1
	selectedTier.Text = "First Age"
	selectedTier.TextColor3 = Color3.fromRGB(150, 150, 200)
	selectedTier.TextSize = 12
	selectedTier.Font = Enum.Font.Gotham
	selectedTier.TextXAlignment = Enum.TextXAlignment.Left
	selectedTier.ZIndex = 9
	selectedTier.Parent = infoContainer

	-- Selected item description
	local selectedDesc = Instance.new("TextLabel")
	selectedDesc.Size = UDim2.new(1, 0, 0, 35)
	selectedDesc.Position = UDim2.new(0, 0, 0, 43)
	selectedDesc.BackgroundTransparency = 1
	selectedDesc.Text = "Smelts 5 clean ores into valuable ingots!\nMix ores = impure ingot"
	selectedDesc.TextColor3 = Color3.fromRGB(180, 180, 190)
	selectedDesc.TextSize = 11
	selectedDesc.Font = Enum.Font.Gotham
	selectedDesc.TextWrapped = true
	selectedDesc.TextXAlignment = Enum.TextXAlignment.Left
	selectedDesc.TextYAlignment = Enum.TextYAlignment.Top
	selectedDesc.ZIndex = 9
	selectedDesc.Parent = infoContainer

	-- Bottom controls row (amount + buttons side by side)
	local controlsRow = Instance.new("Frame")
	controlsRow.Size = UDim2.new(1, 0, 0, 70)
	controlsRow.Position = UDim2.new(0, 0, 1, -70)
	controlsRow.BackgroundTransparency = 1
	controlsRow.ZIndex = 9
	controlsRow.Parent = infoContainer

	-- Amount controls with modern styling (left side of controls row)
	local amountFrame = Instance.new("Frame")
	amountFrame.Size = UDim2.new(0, 110, 1, 0)
	amountFrame.Position = UDim2.new(0, 0, 0, 0)
	amountFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
	amountFrame.BackgroundTransparency = 0.3
	amountFrame.BorderSizePixel = 0
	amountFrame.ZIndex = 10
	amountFrame.Parent = controlsRow

	local amountCorner = Instance.new("UICorner")
	amountCorner.CornerRadius = UDim.new(0, 10)
	amountCorner.Parent = amountFrame

	-- Amount frame stroke
	local amountStroke = Instance.new("UIStroke")
	amountStroke.Color = Color3.fromRGB(60, 60, 80)
	amountStroke.Thickness = 1
	amountStroke.Transparency = 0.6
	amountStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	amountStroke.Parent = amountFrame

	local decreaseBtn = Instance.new("TextButton")
	decreaseBtn.Size = UDim2.new(0, 30, 1, 0)
	decreaseBtn.Position = UDim2.new(0, 0, 0, 0)
	decreaseBtn.BackgroundTransparency = 1
	decreaseBtn.Text = "âˆ’"
	decreaseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	decreaseBtn.TextSize = 20
	decreaseBtn.Font = Enum.Font.GothamBold
	decreaseBtn.ZIndex = 11
	decreaseBtn.Parent = amountFrame

	local amountLabel = Instance.new("TextLabel")
	amountLabel.Size = UDim2.new(1, -60, 1, 0)
	amountLabel.Position = UDim2.new(0, 30, 0, 0)
	amountLabel.BackgroundTransparency = 1
	amountLabel.Text = "1"
	amountLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	amountLabel.TextSize = 16
	amountLabel.Font = Enum.Font.GothamBold
	amountLabel.ZIndex = 11
	amountLabel.Parent = amountFrame

	local increaseBtn = Instance.new("TextButton")
	increaseBtn.Size = UDim2.new(0, 30, 1, 0)
	increaseBtn.Position = UDim2.new(1, -30, 0, 0)
	increaseBtn.BackgroundTransparency = 1
	increaseBtn.Text = "+"
	increaseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	increaseBtn.TextSize = 20
	increaseBtn.Font = Enum.Font.GothamBold
	increaseBtn.ZIndex = 11
	increaseBtn.Parent = amountFrame

	-- Buttons container (right side of controls row)
	local buttonsContainer = Instance.new("Frame")
	buttonsContainer.Size = UDim2.new(1, -120, 1, 0)
	buttonsContainer.Position = UDim2.new(0, 120, 0, 0)
	buttonsContainer.BackgroundTransparency = 1
	buttonsContainer.ZIndex = 10
	buttonsContainer.Parent = controlsRow

	-- Buy button with modern styling
	local buyButton = Instance.new("TextButton")
	buyButton.Size = UDim2.new(1, 0, 0, 33)
	buyButton.Position = UDim2.new(0, 0, 0, 0)
	buyButton.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
	buyButton.BackgroundTransparency = 0
	buyButton.Text = "ðŸ’° Buy - 150"
	buyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	buyButton.TextSize = 14
	buyButton.Font = Enum.Font.GothamBold
	buyButton.ZIndex = 11
	buyButton.Parent = buttonsContainer

	local buyCorner = Instance.new("UICorner")
	buyCorner.CornerRadius = UDim.new(0, 10)
	buyCorner.Parent = buyButton

	-- Buy button stroke
	local buyStroke = Instance.new("UIStroke")
	buyStroke.Color = Color3.fromRGB(0, 0, 0)
	buyStroke.Thickness = 1
	buyStroke.Transparency = 0.7
	buyStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	buyStroke.Parent = buyButton

	-- Cancel button with modern styling
	local cancelButton = Instance.new("TextButton")
	cancelButton.Size = UDim2.new(1, 0, 0, 32)
	cancelButton.Position = UDim2.new(0, 0, 1, -32)
	cancelButton.BackgroundColor3 = Color3.fromRGB(70, 70, 75)
	cancelButton.BackgroundTransparency = 0
	cancelButton.Text = "Cancel"
	cancelButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	cancelButton.TextSize = 14
	cancelButton.Font = Enum.Font.GothamBold
	cancelButton.ZIndex = 11
	cancelButton.Parent = buttonsContainer

	local cancelCorner = Instance.new("UICorner")
	cancelCorner.CornerRadius = UDim.new(0, 10)
	cancelCorner.Parent = cancelButton

	-- Cancel button stroke
	local cancelStroke = Instance.new("UIStroke")
	cancelStroke.Color = Color3.fromRGB(0, 0, 0)
	cancelStroke.Thickness = 1
	cancelStroke.Transparency = 0.7
	cancelStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	cancelStroke.Parent = cancelButton

	-- Category buttons data (HARDCODED - DO NOT CHANGE)
	local categories = {
		{Name = "MachineTab", Display = "Machines", Icon = "âš™ï¸"},
		{Name = "MineTab", Display = "Conveyors", Icon = "ðŸšš"},
		{Name = "DecorTab", Display = "Decor", Icon = "ðŸŽ¨"},
	}

	-- Store category buttons for later reference
	local categoryButtons = {}

	-- Create category buttons
	for i, category in pairs(categories) do
		local tabButton = Instance.new("TextButton")
		tabButton.Name = category.Name
		tabButton.Size = UDim2.new(0, 125, 0, 35)
		tabButton.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
		tabButton.BackgroundTransparency = 0
		tabButton.Text = category.Icon .. " " .. category.Display
		tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
		tabButton.TextSize = 14
		tabButton.Font = Enum.Font.GothamBold
		tabButton.LayoutOrder = i
		tabButton.ZIndex = 8
		tabButton.Parent = categoryFrame

		local tabCorner = Instance.new("UICorner")
		tabCorner.CornerRadius = UDim.new(0, 10)
		tabCorner.Parent = tabButton

		-- Tab button stroke
		local tabStroke = Instance.new("UIStroke")
		tabStroke.Color = Color3.fromRGB(0, 0, 0)
		tabStroke.Thickness = 1
		tabStroke.Transparency = 0.7
		tabStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
		tabStroke.Parent = tabButton

		table.insert(categoryButtons, tabButton)

		tabButton.MouseButton1Click:Connect(function()
			SoundManager.ButtonClick()
			CURRENT_TAB = category.Name
			allButton.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
			allButton.TextColor3 = Color3.fromRGB(255, 255, 255)
			for _, btn in pairs(categoryButtons) do
				btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
				btn.TextColor3 = Color3.fromRGB(255, 255, 255)
			end
			tabButton.BackgroundColor3 = Color3.fromRGB(100, 70, 140)
			tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
			LOAD_SHOP()
		end)
	end

	-- All button click handler
	allButton.MouseButton1Click:Connect(function()
		SoundManager.ButtonClick()
		CURRENT_TAB = "AllTab"
		allButton.BackgroundColor3 = Color3.fromRGB(100, 70, 140)
		allButton.TextColor3 = Color3.fromRGB(255, 255, 255)
		for _, btn in pairs(categoryButtons) do
			btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
			btn.TextColor3 = Color3.fromRGB(255, 255, 255)
		end
		LOAD_SHOP()
	end)

	-- Function to check if item matches search and category
	local function SEARCH_ITEM(ITEM_BUTTON, ITEM_INFO)
		local CAN_SHOW = true

		-- Hide hotspot-only items
		if ITEM_INFO.SpecialTags and ITEM_INFO.SpecialTags.HotspotOnly then
			return false
		end

		-- Search filter
		if string.len(searchBox.Text) > 0 then
			if not string.find(string.lower(ITEM_BUTTON:GetAttribute("ITEM_NAME")), string.lower(searchBox.Text)) then
				CAN_SHOW = false
			end
		end

		-- Category filter
		if CAN_SHOW and CURRENT_TAB ~= "AllTab" then
			if CURRENT_TAB ~= ITEM_INFO.ItemType then
				CAN_SHOW = false
			end
		end

		return CAN_SHOW
	end

	local function IS_ITEM_UNLOCKED(ITEM_ID)
		if INV and INV[ITEM_ID] then
			return INV[ITEM_ID].Unlocked == true
		end
		return false
	end

	LOAD_SHOP = function()
		INV = RepStorage.Events.GetInventoryType:InvokeServer("Items")

		-- Clear existing items
		for _, child in pairs(itemsScroll:GetChildren()) do
			if child:IsA("Frame") then
				child:Destroy()
			end
		end

		for _, ITEM in pairs(RepStorage.Items:GetChildren()) do
			local ITEM_INFO = require(ITEM.ItemStats)
			local isUnlocked = IS_ITEM_UNLOCKED(ITEM_INFO.ItemId)

			-- Create item card with modern styling
			local itemCard = Instance.new("Frame")
			itemCard.Name = "Item" .. ITEM_INFO.ItemId
			itemCard.Size = UDim2.new(0, 155, 0, 210)
			itemCard.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
			itemCard.BackgroundTransparency = 0.2
			itemCard.BorderSizePixel = 0
			itemCard.LayoutOrder = ITEM_INFO.Cost
			itemCard.ZIndex = 8
			itemCard:SetAttribute("ITEM_NAME", ITEM.Name)
			itemCard:SetAttribute("ITEM_ID", ITEM_INFO.ItemId)
			itemCard:SetAttribute("IS_UNLOCKED", isUnlocked)

			local cardCorner = Instance.new("UICorner")
			cardCorner.CornerRadius = UDim.new(0, 12)
			cardCorner.Parent = itemCard

			-- Card stroke
			local cardStroke = Instance.new("UIStroke")
			cardStroke.Color = Color3.fromRGB(60, 60, 80)
			cardStroke.Thickness = 1
			cardStroke.Transparency = 0.6
			cardStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
			cardStroke.Parent = itemCard

			-- Item image
			local itemImage = Instance.new("ImageLabel")
			itemImage.Size = UDim2.new(1, -10, 0, 140)
			itemImage.Position = UDim2.new(0, 5, 0, 5)
			itemImage.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
			itemImage.BorderSizePixel = 0
			itemImage.Image = ITEM_INFO.ThumbnailId
			itemImage.ImageTransparency = isUnlocked and 0 or 0.5
			itemImage.ZIndex = 9
			itemImage.Parent = itemCard

			local imageCorner = Instance.new("UICorner")
			imageCorner.CornerRadius = UDim.new(0, 10)
			imageCorner.Parent = itemImage

			-- Lock icon
			if not isUnlocked then
				local lockIcon = Instance.new("TextLabel")
				lockIcon.Size = UDim2.new(0, 50, 0, 50)
				lockIcon.Position = UDim2.new(0.5, -25, 0.5, -25)
				lockIcon.BackgroundTransparency = 1
				lockIcon.Text = "ðŸ”’"
				lockIcon.TextSize = 35
				lockIcon.ZIndex = 10
				lockIcon.Parent = itemImage
			end

			-- Item name
			local itemName = Instance.new("TextLabel")
			itemName.Size = UDim2.new(1, -10, 0, 25)
			itemName.Position = UDim2.new(0, 5, 0, 150)
			itemName.BackgroundTransparency = 1
			itemName.Text = ITEM.Name
			itemName.TextColor3 = Color3.fromRGB(255, 255, 255)
			itemName.TextSize = 13
			itemName.Font = Enum.Font.GothamBold
			itemName.TextXAlignment = Enum.TextXAlignment.Center
			itemName.TextTruncate = Enum.TextTruncate.AtEnd
			itemName.ZIndex = 9
			itemName.Parent = itemCard

			-- Price/Lock label with modern styling
			local priceLabel = Instance.new("TextLabel")
			priceLabel.Size = UDim2.new(1, -10, 0, 30)
			priceLabel.Position = UDim2.new(0, 5, 1, -35)
			priceLabel.BackgroundColor3 = isUnlocked and Color3.fromRGB(70, 130, 70) or Color3.fromRGB(130, 60, 60)
			priceLabel.BackgroundTransparency = 0
			priceLabel.BorderSizePixel = 0
			priceLabel.Text = isUnlocked and ("ðŸ’° $" .. CASH_LIB.SUFFIX_NUM(ITEM_INFO.Cost)) or "ðŸ”’ Locked"
			priceLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
			priceLabel.TextSize = 14
			priceLabel.Font = Enum.Font.GothamBold
			priceLabel.ZIndex = 9
			priceLabel.Parent = itemCard

			local priceCorner = Instance.new("UICorner")
			priceCorner.CornerRadius = UDim.new(0, 8)
			priceCorner.Parent = priceLabel

			-- Price label stroke
			local priceStroke = Instance.new("UIStroke")
			priceStroke.Color = Color3.fromRGB(0, 0, 0)
			priceStroke.Thickness = 1
			priceStroke.Transparency = 0.7
			priceStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
			priceStroke.Parent = priceLabel

			itemCard.Visible = SEARCH_ITEM(itemCard, ITEM_INFO)

			-- Click button (invisible overlay)
			local clickButton = Instance.new("TextButton")
			clickButton.Size = UDim2.new(1, 0, 1, 0)
			clickButton.BackgroundTransparency = 1
			clickButton.Text = ""
			clickButton.ZIndex = 10
			clickButton.Parent = itemCard

			-- Click handler
			clickButton.MouseButton1Click:Connect(function()
				if DB then
					SoundManager.ButtonClick()
					DB = false
					SELECTED_ITEM = ITEM
					CURRENT_COST = ITEM_INFO.Cost
					AMOUNT = 1

					selectedIcon.Image = ITEM_INFO.ThumbnailId
					selectedName.Text = ITEM.Name

					-- Set description with unlock requirement if locked
					if isUnlocked then
						selectedDesc.Text = ITEM_INFO.Description
					else
						-- Get unlock requirement from server
						local unlockResearch = RepStorage.Events.GetItemUnlockRequirement:InvokeServer(ITEM_INFO.ItemId)
						if unlockResearch then
							selectedDesc.Text = "ðŸ”’ LOCKED - Complete: " .. unlockResearch.Name .. "\n\n" .. ITEM_INFO.Description
						else
							selectedDesc.Text = "ðŸ”’ LOCKED\n\n" .. ITEM_INFO.Description
						end
					end

					amountLabel.Text = "1"

					-- Get tier info
					local MainLib = require(RepStorage.Modules.MainLib)
					local tierName, tierData = MainLib.GET_ITEM_TIER_INFO(ITEM.Name)
					selectedTier.Text = tierName or ("Tier " .. ITEM_INFO.TierId)
					selectedTier.TextColor3 = tierData and tierData["TIER_COLOR"] or Color3.fromRGB(150, 150, 150)

					if isUnlocked then
						buyButton.Text = "ðŸ’° Buy - " .. CASH_LIB.SUFFIX_NUM(ITEM_INFO.Cost)
						buyButton.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
					else
						buyButton.Text = "ðŸ”’ LOCKED"
						buyButton.BackgroundColor3 = Color3.fromRGB(130, 50, 50)
					end

					selectedPanel.Visible = true
					wait(0.1)
					DB = true
				end
			end)

			-- Hover handlers
			clickButton.MouseEnter:Connect(function()
				script.Parent.Parent.ItemHover.ButtonHovering.Value = itemCard
			end)

			clickButton.MouseLeave:Connect(function()
				if script.Parent.Parent.ItemHover.ButtonHovering.Value == itemCard then
					script.Parent.Parent.ItemHover.ButtonHovering.Value = nil
				end
			end)

			itemCard.Parent = itemsScroll
		end

		-- Update canvas size
		itemsScroll.CanvasSize = UDim2.new(0, 0, 0, itemsGrid.AbsoluteContentSize.Y + 20)
	end

	-- Amount controls
	decreaseBtn.MouseButton1Click:Connect(function()
		AMOUNT = math.max(1, AMOUNT - 1)
		amountLabel.Text = tostring(AMOUNT)
		if SELECTED_ITEM then
			local ITEM_INFO = require(SELECTED_ITEM.ItemStats)
			buyButton.Text = "ðŸ’° Buy - " .. CASH_LIB.SUFFIX_NUM(ITEM_INFO.Cost * AMOUNT)
		end
	end)

	increaseBtn.MouseButton1Click:Connect(function()
		AMOUNT = math.min(99, AMOUNT + 1)
		amountLabel.Text = tostring(AMOUNT)
		if SELECTED_ITEM then
			local ITEM_INFO = require(SELECTED_ITEM.ItemStats)
			buyButton.Text = "ðŸ’° Buy - " .. CASH_LIB.SUFFIX_NUM(ITEM_INFO.Cost * AMOUNT)
		end
	end)

	-- Buy button
	buyButton.MouseButton1Click:Connect(function()
		if DB and SELECTED_ITEM then
			DB = false
			local ITEM_INFO = require(SELECTED_ITEM.ItemStats)

			if IS_ITEM_UNLOCKED(ITEM_INFO.ItemId) then
				local ITEM_BOUGHT = RepStorage.Events.BuyItem:InvokeServer(ITEM_INFO.ItemId, math.floor(AMOUNT))
				if ITEM_BOUGHT then
					SoundManager.Purchase()
					LOAD_SHOP()
				else
					SoundManager.Error()
				end
			else
				SoundManager.Error()
			end

			wait(0.1)
			DB = true
		end
	end)

	-- Cancel button
	cancelButton.MouseButton1Click:Connect(function()
		SELECTED_ITEM = nil
		selectedPanel.Visible = false
	end)

	-- Search handlers
	searchBox:GetPropertyChangedSignal("Text"):Connect(function()
		clearButton.Visible = string.len(searchBox.Text) > 0
		LOAD_SHOP()
	end)

	-- Menu toggle handler
	script.Parent.MenuObject.Changed:Connect(function()
		if script.Parent.MenuObject.Value then
			shopFrame.Visible = true
			LOAD_SHOP()
		else
			shopFrame.Visible = false
			selectedPanel.Visible = false
		end
	end)
end

return module
