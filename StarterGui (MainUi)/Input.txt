local module = {}

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local InputService = SERVICES["UserInputService"]
	local RepStorage = SERVICES["ReplicatedStorage"]
	local Plrs = SERVICES["Players"]
	-- ADD THIS LINE:
	local ProximityPromptService = game:GetService("ProximityPromptService")

	-- Modules
	local ItemSelection = MODULES["ItemSelection"]
	local PlacementLib = MODULES["PlacementLib"]
	local PLACEMENT = MODULES["Placement"]
	local Main = MODULES["Main"]
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	local Mouse = Plr:GetMouse()
	local PlayerGui = Plr:WaitForChild("PlayerGui")
	local ResearchGui = PlayerGui:WaitForChild("ResearchGui", 10)
	local PLR_PLOT = Plr.SetPlot.Value
	local SoundManager = require(RepStorage.Modules.SoundManager)
	-- Variables
	-- Booleans
	local DB = true
	module.MOUSE_DOWN = false
	-- NEW: Track touch position for mobile AND track if actively touching
	module.TOUCH_POSITION = nil
	module.IS_TOUCHING = false
	module.IS_MOBILE = InputService.TouchEnabled and not InputService.KeyboardEnabled
	-- NEW: Track touch movement to detect swipe vs tap
	local touchStartPosition = nil
	local touchStartTime = 0
	local SWIPE_THRESHOLD = 10  -- pixels moved before considered a swipe
	-- NEW: Simple tap tracking - tap stays active for a short time
	module.TAP_ACTIVE = false
	module.TAP_POSITION = nil

	-- ADD THESE LINES - ProximityPrompt cooldown system:
	local lastProximityPromptTime = 0
	local PROXIMITY_COOLDOWN = 2  -- 300ms cooldown after using proximity prompt

	-- Track when ANY proximity prompt is triggered
	ProximityPromptService.PromptTriggered:Connect(function(prompt, player)
		if player == Plr then
			lastProximityPromptTime = tick()
		end
	end)
	-- END OF ADDITION

	InputService.InputBegan:Connect(function(KEY_INPUT, PROCESSED)
		if PROCESSED then
			return false
		end
		-- Detect Mouse Click
		if KEY_INPUT.UserInputType == Enum.UserInputType.MouseButton1 then
			module.MOUSE_DOWN = true
		end
		-- Detect Touch Input and store position
		if KEY_INPUT.UserInputType == Enum.UserInputType.Touch then
			-- Store initial touch position to detect swipes
			touchStartPosition = KEY_INPUT.Position
			touchStartTime = tick()
			module.TOUCH_POSITION = KEY_INPUT.Position
			module.IS_TOUCHING = true
		end
	end)

	-- NEW: Track touch movement to detect swipe vs tap
	InputService.InputChanged:Connect(function(KEY_INPUT, PROCESSED)
		if PROCESSED then
			return
		end
		-- Update touch position while moving finger
		if KEY_INPUT.UserInputType == Enum.UserInputType.Touch and module.IS_TOUCHING then
			module.TOUCH_POSITION = KEY_INPUT.Position

			-- Check if finger moved significantly (swipe)
			if touchStartPosition then
				local movementDistance = (KEY_INPUT.Position - touchStartPosition).Magnitude

				-- If moved more than threshold, it's a swipe (camera movement)
				if movementDistance > SWIPE_THRESHOLD then
					module.MOUSE_DOWN = false  -- NOT a tap, it's a swipe
					touchStartPosition = nil  -- Clear start position
				end
			end
		end
	end)

	InputService.InputEnded:Connect(function(KEY_INPUT, PROCESSED)
		if PROCESSED then
			return false
		end
		-- Detect Mouse Release
		if KEY_INPUT.UserInputType == Enum.UserInputType.MouseButton1 then
			module.MOUSE_DOWN = false
		end
		-- Detect Touch End
		if KEY_INPUT.UserInputType == Enum.UserInputType.Touch then
			local currentTime = tick()

			-- Check if it was a tap (minimal movement and quick)
			if touchStartPosition and module.TOUCH_POSITION then
				local movementDistance = (module.TOUCH_POSITION - touchStartPosition).Magnitude
				local touchDuration = currentTime - touchStartTime

				-- If movement was small and quick, it's a TAP
				if movementDistance <= SWIPE_THRESHOLD and touchDuration < 0.5 then
					-- TAP detected - save position and activate flag
					module.TAP_ACTIVE = true
					module.TAP_POSITION = module.TOUCH_POSITION

					-- If we're placing items, also set MOUSE_DOWN to trigger placement
					if PLACEMENT.PLACING_ITEMS then
						module.MOUSE_DOWN = true
						-- Clear MOUSE_DOWN quickly after placement is triggered
						task.spawn(function()
							task.wait(0.1)
							module.MOUSE_DOWN = false
						end)
					end

					-- Clear tap flag after a short delay (but position stays)
					task.spawn(function()
						task.wait(0.2)
						module.TAP_ACTIVE = false
					end)
				end
			end

			-- Clear touch data
			module.TOUCH_POSITION = nil
			module.IS_TOUCHING = false
			touchStartPosition = nil
		end
		-- Regular Input
		if KEY_INPUT.KeyCode == Enum.KeyCode.R then
			if PLACEMENT.PLACING_ITEMS then
				PlacementLib.rotate()
				SoundManager.RotateItem()
			elseif not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.MOVE_ITEMS()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.F then
			if PLACEMENT.PLACING_ITEMS then
				if PLACEMENT.FLIP_CONVEYOR_DIRECTION then
					PLACEMENT.FLIP_CONVEYOR_DIRECTION()
				end
			elseif not PLACEMENT.PLACING_ITEMS then
				Main.OPEN_MENU(script.Parent.Parent.Shop)
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.T then
			if not PLACEMENT.PLACING_ITEMS and not module.SELECTING_ITEMS then
				if ResearchGui then
					Main.OPEN_MENU(ResearchGui)
				end
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.Q then
			if PLACEMENT.PLACING_ITEMS then
				PLACEMENT.DESTROY_PLACING()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.Z then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.WITHDRAW_ITEM()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.X then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.SELL_ITEMS()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.E then
			-- ADD THIS CHECK - Don't open inventory if we just used a proximity prompt:
			if tick() - lastProximityPromptTime < PROXIMITY_COOLDOWN then
				return  -- Ignore the E press
			end
			-- EXISTING CODE:
			if not PLACEMENT.PLACING_ITEMS then
				Main.OPEN_MENU(script.Parent.Parent.Inv)
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.C then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.BUY_ITEMS()
			elseif not PLACEMENT.PLACING_ITEMS then
				Main.OPEN_MENU(script.Parent.Parent.Options)
			end
		end
	end)

	-- ========================================
	-- MODERN PLACEMENT MENU BUTTON CONNECTIONS
	-- ========================================
	-- Wait for PlacementMenu to load and get reference to modern menu
	task.wait(0.5)  -- Small delay to ensure everything is loaded
	local PlacementMenu = MODULES["PlacementMenu"]

	-- Connect modern placement menu buttons
	if PlacementMenu.ModernMenu then
		local modernMenu = PlacementMenu.ModernMenu

		-- Place button (left click when placing)
		modernMenu.PlaceButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				if PLACEMENT.PLACE_ITEM() then
					PLACEMENT.DESTROY_PLACING()
				end
			end
		end)

		-- Rotate button (R key)
		modernMenu.RotateButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				PlacementLib.rotate()
			end
		end)

		-- Flip button (F key)
		modernMenu.FlipButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				if PLACEMENT.FLIP_CONVEYOR_DIRECTION then
					PLACEMENT.FLIP_CONVEYOR_DIRECTION()
				end
			end
		end)

		-- Cancel button (Q key)
		modernMenu.CancelButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				PLACEMENT.DESTROY_PLACING()
			end
		end)
	end
end

return module
