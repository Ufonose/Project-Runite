local module = {}

function module.LOAD(MODULE_INFO)
	-- Basic Needs
	local MODULES = MODULE_INFO["MODULES"]
	local SERVICES = MODULE_INFO["SERVICES"]
	-- Services
	local InputService = SERVICES["UserInputService"]
	local RepStorage = SERVICES["ReplicatedStorage"]
	local Plrs = SERVICES["Players"]
	-- Modules
	local ItemSelection = MODULES["ItemSelection"]
	local PlacementLib = MODULES["PlacementLib"]
	local PLACEMENT = MODULES["Placement"]
	local Main = MODULES["Main"]
	-- Plr Info
	local Plr = Plrs.LocalPlayer
	local Mouse = Plr:GetMouse()
	local PlayerGui = Plr:WaitForChild("PlayerGui")
	local ResearchGui = PlayerGui:WaitForChild("ResearchGui", 10)
	local PLR_PLOT = Plr.SetPlot.Value
	-- Variables
	-- Booleans
	local DB = true
	module.MOUSE_DOWN = false

	InputService.InputBegan:Connect(function(KEY_INPUT, PROCESSED)
		if PROCESSED then
			return false
		end
		-- Safer Mouse Input Detection
		if KEY_INPUT.UserInputType == Enum.UserInputType.MouseButton1 then
			module.MOUSE_DOWN = true
		end
	end)

	InputService.InputEnded:Connect(function(KEY_INPUT, PROCESSED)
		if PROCESSED then
			return false
		end
		-- Safer Mouse Input Detection
		if KEY_INPUT.UserInputType == Enum.UserInputType.MouseButton1 then
			module.MOUSE_DOWN = false
		end
		-- Regular Input
		if KEY_INPUT.KeyCode == Enum.KeyCode.R then
			if PLACEMENT.PLACING_ITEMS then
				PlacementLib.rotate()
			elseif not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.MOVE_ITEMS()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.F then
			print("F key pressed! PLACING_ITEMS:", PLACEMENT.PLACING_ITEMS)
			if PLACEMENT.PLACING_ITEMS then
				print("Attempting to flip conveyor...")
				if PLACEMENT.FLIP_CONVEYOR_DIRECTION then
					PLACEMENT.FLIP_CONVEYOR_DIRECTION()
					print("Flip function called!")
				else
					warn("FLIP_CONVEYOR_DIRECTION function not found!")
				end
			elseif not PLACEMENT.PLACING_ITEMS then
				print("Opening shop instead...")
				Main.OPEN_MENU(script.Parent.Parent.Shop)
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.T then
			if not PLACEMENT.PLACING_ITEMS and not module.SELECTING_ITEMS then
				if ResearchGui then
					Main.OPEN_MENU(ResearchGui)
				else
					warn("ResearchGui not found!")
				end
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.Q then
			if PLACEMENT.PLACING_ITEMS then
				PLACEMENT.DESTROY_PLACING()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.Z then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.WITHDRAW_ITEM()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.X then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.SELL_ITEMS()
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.E then
			if not PLACEMENT.PLACING_ITEMS then
				Main.OPEN_MENU(script.Parent.Parent.Inv)
			end
		elseif KEY_INPUT.KeyCode == Enum.KeyCode.C then
			if not module.SELECTING_ITEMS and ItemSelection.SELECTED_COUNT > 0 then
				ItemSelection.BUY_ITEMS()
			elseif not PLACEMENT.PLACING_ITEMS then
				Main.OPEN_MENU(script.Parent.Parent.Options)
			end
		end
	end)

	-- ========================================
	-- MODERN PLACEMENT MENU BUTTON CONNECTIONS
	-- ========================================
	-- Wait for PlacementMenu to load and get reference to modern menu
	task.wait(0.5)  -- Small delay to ensure everything is loaded
	local PlacementMenu = MODULES["PlacementMenu"]

	-- Connect modern placement menu buttons
	if PlacementMenu.ModernMenu then
		local modernMenu = PlacementMenu.ModernMenu

		-- Place button (left click when placing)
		modernMenu.PlaceButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				if PLACEMENT.PLACE_ITEM() then
					PLACEMENT.DESTROY_PLACING()
				end
			end
		end)

		-- Rotate button (R key)
		modernMenu.RotateButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				PlacementLib.rotate()
			end
		end)

		-- Flip button (F key)
		modernMenu.FlipButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				print("Flip button clicked! Attempting to flip conveyor...")
				if PLACEMENT.FLIP_CONVEYOR_DIRECTION then
					PLACEMENT.FLIP_CONVEYOR_DIRECTION()
					print("Flip function called!")
				else
					warn("FLIP_CONVEYOR_DIRECTION function not found!")
				end
			end
		end)

		-- Cancel button (Q key)
		modernMenu.CancelButton.MouseButton1Click:Connect(function()
			if PLACEMENT.PLACING_ITEMS then
				PLACEMENT.DESTROY_PLACING()
			end
		end)

		print("Modern Placement Menu buttons connected!")
	else
		warn("ModernMenu not found in PlacementMenu!")
	end
end

return module
