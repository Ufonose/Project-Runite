local Players = game:GetService("Players")
local RepStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local researchGui = script.Parent

-- Create main frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 800, 0, 600)
mainFrame.Position = UDim2.new(0.5, -400, 0.5, -300)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
mainFrame.Parent = researchGui

-- Add UICorner
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = mainFrame

-- Create title bar
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 50)
titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 12)
titleCorner.Parent = titleBar

-- Title text
local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(0.7, 0, 1, 0)
titleText.Position = UDim2.new(0, 15, 0, 0)
titleText.BackgroundTransparency = 1
titleText.Text = "Research Objectives"
titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
titleText.TextSize = 24
titleText.Font = Enum.Font.GothamBold
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = titleBar

-- Research tokens display
local tokensLabel = Instance.new("TextLabel")
tokensLabel.Size = UDim2.new(0.3, -15, 1, 0)
tokensLabel.Position = UDim2.new(0.7, 0, 0, 0)
tokensLabel.BackgroundTransparency = 1
tokensLabel.Text = "ðŸ”¬ 0 Tokens"
tokensLabel.TextColor3 = Color3.fromRGB(134, 207, 255)
tokensLabel.TextSize = 18
tokensLabel.Font = Enum.Font.GothamBold
tokensLabel.TextXAlignment = Enum.TextXAlignment.Right
tokensLabel.Parent = titleBar

-- Close button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 40, 0, 40)
closeButton.Position = UDim2.new(1, -45, 0, 5)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextSize = 20
closeButton.Font = Enum.Font.GothamBold
closeButton.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 8)
closeCorner.Parent = closeButton

closeButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
end)

-- Research mode toggle
local modeToggle = Instance.new("TextButton")
modeToggle.Size = UDim2.new(0, 200, 0, 40)
modeToggle.Position = UDim2.new(0, 15, 0, 60)
modeToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
modeToggle.Text = "Cash Mode ðŸ’°"
modeToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
modeToggle.TextSize = 16
modeToggle.Font = Enum.Font.GothamBold
modeToggle.Parent = mainFrame

local modeCorner = Instance.new("UICorner")
modeCorner.CornerRadius = UDim.new(0, 8)
modeCorner.Parent = modeToggle

local isResearchMode = false

modeToggle.MouseButton1Click:Connect(function()
	isResearchMode = RepStorage.Events.ToggleResearchMode:InvokeServer()

	if isResearchMode then
		modeToggle.Text = "Research Mode ðŸ”¬"
		modeToggle.BackgroundColor3 = Color3.fromRGB(101, 167, 207)
	else
		modeToggle.Text = "Cash Mode ðŸ’°"
		modeToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
	end
end)

-- Scrolling frame for objectives
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Name = "ObjectivesScroll"
scrollFrame.Size = UDim2.new(1, -30, 1, -120)
scrollFrame.Position = UDim2.new(0, 15, 0, 110)
scrollFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 8
scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 105)
scrollFrame.Parent = mainFrame

local scrollCorner = Instance.new("UICorner")
scrollCorner.CornerRadius = UDim.new(0, 8)
scrollCorner.Parent = scrollFrame

-- Add UIListLayout to scrolling frame
local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 10)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = scrollFrame

-- Function to create objective card
local function createObjectiveCard(objectiveData, researchData)
	local isCompleted = table.find(researchData.CompletedObjectives, objectiveData.Id) ~= nil
	local isActive = table.find(researchData.ActiveObjectives, objectiveData.Id) ~= nil
	local canStart = not isCompleted and not isActive

	-- Check if prerequisites are met
	local prereqsMet = true
	for _, reqId in pairs(objectiveData.RequiredObjectives) do
		if not table.find(researchData.CompletedObjectives, reqId) then
			prereqsMet = false
			break
		end
	end

	local card = Instance.new("Frame")
	card.Name = "ObjectiveCard_" .. objectiveData.Id
	card.Size = UDim2.new(1, -10, 0, 150)
	card.BackgroundColor3 = isCompleted and Color3.fromRGB(40, 80, 40) or (isActive and Color3.fromRGB(60, 80, 120) or Color3.fromRGB(45, 45, 50))
	card.BorderSizePixel = 0
	card.LayoutOrder = objectiveData.Tier * 100 + objectiveData.Id

	local cardCorner = Instance.new("UICorner")
	cardCorner.CornerRadius = UDim.new(0, 10)
	cardCorner.Parent = card

	-- Tier badge
	local tierBadge = Instance.new("TextLabel")
	tierBadge.Size = UDim2.new(0, 60, 0, 30)
	tierBadge.Position = UDim2.new(0, 10, 0, 10)
	tierBadge.BackgroundColor3 = Color3.fromRGB(100, 60, 150)
	tierBadge.Text = "Tier " .. objectiveData.Tier
	tierBadge.TextColor3 = Color3.fromRGB(255, 255, 255)
	tierBadge.TextSize = 14
	tierBadge.Font = Enum.Font.GothamBold
	tierBadge.Parent = card

	local badgeCorner = Instance.new("UICorner")
	badgeCorner.CornerRadius = UDim.new(0, 6)
	badgeCorner.Parent = tierBadge

	-- Title
	local title = Instance.new("TextLabel")
	title.Size = UDim2.new(1, -150, 0, 30)
	title.Position = UDim2.new(0, 80, 0, 10)
	title.BackgroundTransparency = 1
	title.Text = objectiveData.Name .. (isCompleted and " âœ“" or "")
	title.TextColor3 = Color3.fromRGB(255, 255, 255)
	title.TextSize = 18
	title.Font = Enum.Font.GothamBold
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.Parent = card

	-- Description
	local desc = Instance.new("TextLabel")
	desc.Size = UDim2.new(1, -20, 0, 25)
	desc.Position = UDim2.new(0, 10, 0, 45)
	desc.BackgroundTransparency = 1
	desc.Text = objectiveData.Description
	desc.TextColor3 = Color3.fromRGB(200, 200, 200)
	desc.TextSize = 14
	desc.Font = Enum.Font.Gotham
	desc.TextXAlignment = Enum.TextXAlignment.Left
	desc.Parent = card

	-- Requirements
	local yPos = 75
	for i, requirement in pairs(objectiveData.Requirements) do
		local progress = 0
		if researchData.ObjectiveProgress[objectiveData.Id] then
			progress = researchData.ObjectiveProgress[objectiveData.Id][requirement.ItemName] or 0
		end

		local reqFrame = Instance.new("Frame")
		reqFrame.Size = UDim2.new(1, -20, 0, 20)
		reqFrame.Position = UDim2.new(0, 10, 0, yPos)
		reqFrame.BackgroundTransparency = 1
		reqFrame.Parent = card

		local reqText = Instance.new("TextLabel")
		reqText.Size = UDim2.new(0.5, 0, 1, 0)
		reqText.BackgroundTransparency = 1
		reqText.Text = "â€¢ " .. requirement.ItemName
		reqText.TextColor3 = Color3.fromRGB(180, 180, 180)
		reqText.TextSize = 12
		reqText.Font = Enum.Font.Gotham
		reqText.TextXAlignment = Enum.TextXAlignment.Left
		reqText.Parent = reqFrame

		local progressText = Instance.new("TextLabel")
		progressText.Size = UDim2.new(0.5, 0, 1, 0)
		progressText.Position = UDim2.new(0.5, 0, 0, 0)
		progressText.BackgroundTransparency = 1
		progressText.Text = progress .. " / " .. requirement.Amount
		progressText.TextColor3 = progress >= requirement.Amount and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 200, 100)
		progressText.TextSize = 12
		progressText.Font = Enum.Font.GothamBold
		progressText.TextXAlignment = Enum.TextXAlignment.Right
		progressText.Parent = reqFrame

		yPos = yPos + 22
	end

	-- Action button
	if not isCompleted then
		local actionButton = Instance.new("TextButton")
		actionButton.Size = UDim2.new(0, 120, 0, 35)
		actionButton.Position = UDim2.new(1, -130, 0, 10)
		actionButton.BackgroundColor3 = isActive and Color3.fromRGB(80, 80, 85) or (prereqsMet and Color3.fromRGB(100, 150, 100) or Color3.fromRGB(100, 50, 50))
		actionButton.Text = isActive and "Active" or (prereqsMet and "Start" or "Locked")
		actionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
		actionButton.TextSize = 14
		actionButton.Font = Enum.Font.GothamBold
		actionButton.Parent = card

		local btnCorner = Instance.new("UICorner")
		btnCorner.CornerRadius = UDim.new(0, 8)
		btnCorner.Parent = actionButton

		if canStart and prereqsMet then
			actionButton.MouseButton1Click:Connect(function()
				local success = RepStorage.Events.StartObjective:InvokeServer(objectiveData.Id)
				if success then
					refreshObjectives()
				end
			end)
		end
	end

	return card
end

-- Function to refresh objectives display
function refreshObjectives()
	-- Clear existing cards
	for _, child in pairs(scrollFrame:GetChildren()) do
		if child:IsA("Frame") then
			child:Destroy()
		end
	end

	-- Get research data
	local researchData = RepStorage.Events.GetResearchData:InvokeServer()

	-- Update tokens display
	tokensLabel.Text = "ðŸ”¬ " .. researchData.ResearchTokens .. " Tokens"

	-- Create cards for all objectives
	for _, objective in pairs(researchData.AllObjectives) do
		local card = createObjectiveCard(objective, researchData)
		card.Parent = scrollFrame
	end

	-- Update canvas size
	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
end

-- Create open button
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(0, 60, 0, 60)
openButton.Position = UDim2.new(1, -80, 0.5, -30)
openButton.BackgroundColor3 = Color3.fromRGB(100, 60, 150)
openButton.Text = "ðŸ”¬"
openButton.TextSize = 30
openButton.Font = Enum.Font.GothamBold
openButton.Parent = researchGui

local openCorner = Instance.new("UICorner")
openCorner.CornerRadius = UDim.new(1, 0)
openCorner.Parent = openButton

openButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
	if mainFrame.Visible then
		refreshObjectives()
	end
end)

-- Auto-refresh when objectives complete
while task.wait(2) do
	if mainFrame.Visible then
		refreshObjectives()
	end
end
