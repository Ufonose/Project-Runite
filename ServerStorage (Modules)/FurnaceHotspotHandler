-- ServerStorage > Modules > FurnaceHotspotHandler

local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")

local FurnaceHotspotHandler = {}

-- There's only ONE furnace hotspot - automatically unlocked for everyone
FurnaceHotspotHandler.HotspotConfig = {
	Id = 1,
	FurnaceName = "Standard Furnace",
	Description = "Your central collection point - all items must go here!",
}

-- Initialize player's furnace hotspot data
function FurnaceHotspotHandler.InitializePlayer(player)
	-- Check if global data exists
	if not _G["global_data"] then
		warn("_G['global_data'] does not exist!")
		return false
	end

	if not _G["global_data"][player.Name] then
		warn("_G['global_data'][" .. player.Name .. "] does not exist! Player data not loaded.")
		return false
	end

	if not _G["global_data"][player.Name]["FurnaceHotspot"] then
		print("Initializing FurnaceHotspot data for", player.Name)
		_G["global_data"][player.Name]["FurnaceHotspot"] = {
			Unlocked = true,  -- ALWAYS UNLOCKED
		}
	end

	return true
end

-- Check if furnace hotspot is unlocked (always true)
function FurnaceHotspotHandler.IsHotspotUnlocked(player)
	if not FurnaceHotspotHandler.InitializePlayer(player) then
		return false
	end

	return _G["global_data"][player.Name]["FurnaceHotspot"].Unlocked == true
end

-- Activate the furnace hotspot (spawn the real furnace)
function FurnaceHotspotHandler.ActivateHotspot(player)
	local plot = player.SetPlot.Value
	if not plot then 
		warn("No plot for", player.Name)
		return 
	end

	local hotspotFolder = plot:FindFirstChild("FurnaceHotspot")
	if not hotspotFolder then 
		warn("No FurnaceHotspot folder in plot")
		return 
	end

	-- Find the Position part
	local positionPart = hotspotFolder:FindFirstChild("Position")
	if not positionPart then
		warn("No Position part found in FurnaceHotspot!")
		return
	end

	local config = FurnaceHotspotHandler.HotspotConfig
	local furnaceModel = RepStorage.Items:FindFirstChild(config.FurnaceName)

	if not furnaceModel then
		warn("Furnace", config.FurnaceName, "not found!")
		return
	end

	-- Clone the furnace and place it at the hotspot
	local activeFurnace = furnaceModel:Clone()

	-- MARK AS HOTSPOT FURNACE (permanent, can't be moved/sold)
	-- THIS IS THE CRITICAL LINE - EXACT SAME AS MINERS
	activeFurnace:SetAttribute("HotspotFurnace", true)

	-- IMPORTANT: Set PrimaryPart to Hitbox
	if activeFurnace:FindFirstChild("Hitbox") then
		activeFurnace.PrimaryPart = activeFurnace.Hitbox
	end

	if positionPart then
		activeFurnace:SetPrimaryPartCFrame(positionPart.CFrame)
	end

	-- MUST parent BEFORE adding layer info
	activeFurnace.Parent = plot.PlacedItems

	-- Add/Update layer info - ALWAYS set it even if it exists
	if activeFurnace:FindFirstChild("ItemStats") then
		local itemStats = require(activeFurnace.ItemStats)

		-- Remove old layer values if they exist
		local oldLayer = activeFurnace:FindFirstChild("PlacementLayer")
		if oldLayer then oldLayer:Destroy() end
		local oldLayers = activeFurnace:FindFirstChild("PlacementLayers")
		if oldLayers then oldLayers:Destroy() end

		-- Create new layer values
		local layerValue = Instance.new("IntValue", activeFurnace)
		layerValue.Name = "PlacementLayer"

		if type(itemStats.PlacementLayer) == "table" then
			layerValue.Value = itemStats.PlacementLayer[1]
			local layersString = Instance.new("StringValue", activeFurnace)
			layersString.Name = "PlacementLayers"
			layersString.Value = table.concat(itemStats.PlacementLayer, ",")
			print("Set multi-layer:", layersString.Value)
		else
			layerValue.Value = itemStats.PlacementLayer or 1
			print("Set single layer:", layerValue.Value)
		end
	end

	-- Make sure Hitbox is configured properly for collision detection
	if activeFurnace.PrimaryPart then
		activeFurnace.PrimaryPart.Transparency = 1
		activeFurnace.PrimaryPart.CanCollide = false
		activeFurnace.PrimaryPart.Anchored = true
	end

	-- Enable scripts
	for _, descendant in pairs(activeFurnace:GetDescendants()) do
		if descendant:IsA("Script") then
			descendant.Disabled = descendant:FindFirstChild("ForceDisabled")
		end
	end

	print("Activated Furnace Hotspot for", player.Name)
	print("Furnace placed at:", activeFurnace:GetPrimaryPartCFrame())
end

-- Get player's furnace hotspot data
function FurnaceHotspotHandler.GetPlayerHotspot(player)
	if not FurnaceHotspotHandler.InitializePlayer(player) then
		return {Unlocked = false}
	end

	return _G["global_data"][player.Name]["FurnaceHotspot"]
end

return FurnaceHotspotHandler
