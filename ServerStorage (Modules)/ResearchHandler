-- ServerStorage (Modules)/ResearchHandler (WITH ITEM UNLOCK NOTIFICATIONS)

local ServerStorage = game:GetService("ServerStorage")
local RepStorage = game:GetService("ReplicatedStorage")
local ResearchData = require(ServerStorage.Modules.ResearchData)

local ResearchHandler = {}

-- Helper function to get item name from item ID
local function getItemNameFromId(itemId)
	-- Search through ReplicatedStorage.Items to find the item with matching ID
	for _, item in pairs(RepStorage.Items:GetChildren()) do
		local itemStats = item:FindFirstChild("ItemStats")
		if itemStats then
			local stats = require(itemStats)
			if stats.ItemId == itemId then
				return item.Name  -- Return the actual item name
			end
		end
	end
	return "Unknown Item"
end

-- Initialize player research data if it doesn't exist
function ResearchHandler.InitializePlayer(player)
	if not _G["global_data"][player.Name]["Research"] then
		print("Initializing research data for", player.Name)
		_G["global_data"][player.Name]["Research"] = {
			CompletedObjectives = {},
			ActiveObjectives = {},
			ObjectiveProgress = {},
			ItemsCollected = {},  -- Track all items collected
		}
	end

	-- Add ItemsCollected if it doesn't exist (for existing saves)
	if not _G["global_data"][player.Name]["Research"]["ItemsCollected"] then
		_G["global_data"][player.Name]["Research"]["ItemsCollected"] = {}
	end
end

-- NEW: Track item collection (called for ALL items processed, not just research)
function ResearchHandler.TrackItemCollection(player, itemName, amount)
	ResearchHandler.InitializePlayer(player)

	local research = _G["global_data"][player.Name]["Research"]

	-- Track the item
	if not research.ItemsCollected[itemName] then
		research.ItemsCollected[itemName] = 0
	end
	research.ItemsCollected[itemName] = research.ItemsCollected[itemName] + amount
end

-- Start tracking an objective
function ResearchHandler.StartObjective(player, objectiveId)
	ResearchHandler.InitializePlayer(player)

	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	if not objective then
		warn("Objective", objectiveId, "not found!")
		return false
	end

	-- Check if already completed
	if table.find(research.CompletedObjectives, objectiveId) then
		return false, "Already completed"
	end

	-- Check if already active
	if table.find(research.ActiveObjectives, objectiveId) then
		return false, "Already active"
	end

	-- Check prerequisites
	if not ResearchData.CanStartObjective(objectiveId, research.CompletedObjectives) then
		return false, "Prerequisites not met"
	end

	-- Start the objective
	table.insert(research.ActiveObjectives, objectiveId)
	research.ObjectiveProgress[tostring(objectiveId)] = {}

	-- Initialize progress for each requirement
	for _, requirement in pairs(objective.Requirements) do
		research.ObjectiveProgress[tostring(objectiveId)][requirement.ItemName] = 0
	end

	return true
end

-- Deposit an item towards an objective
function ResearchHandler.DepositItem(player, objectiveId, itemName, amount)
	ResearchHandler.InitializePlayer(player)

	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	if not objective then 
		return false 
	end

	-- Check if objective is active
	if not table.find(research.ActiveObjectives, objectiveId) then
		return false
	end

	-- Find the requirement
	local requirement = nil
	for _, req in pairs(objective.Requirements) do
		if req.ItemName == itemName then
			requirement = req
			break
		end
	end

	if not requirement then
		return false
	end

	-- Update progress
	local progressKey = tostring(objectiveId)
	local currentProgress = research.ObjectiveProgress[progressKey][itemName] or 0
	local newProgress = math.min(currentProgress + amount, requirement.Amount)
	research.ObjectiveProgress[progressKey][itemName] = newProgress

	-- Check if objective is complete
	local isComplete = ResearchHandler.CheckObjectiveComplete(player, objectiveId)

	if isComplete then
		ResearchHandler.CompleteObjective(player, objectiveId)
	end

	return true, newProgress
end

-- Check if an objective is complete
function ResearchHandler.CheckObjectiveComplete(player, objectiveId)
	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	if not objective or not research.ObjectiveProgress[tostring(objectiveId)] then
		return false
	end

	-- Check all requirements
	for _, requirement in pairs(objective.Requirements) do
		local progress = research.ObjectiveProgress[tostring(objectiveId)][requirement.ItemName] or 0
		if progress < requirement.Amount then
			return false
		end
	end

	return true
end

-- Complete an objective and give rewards
function ResearchHandler.CompleteObjective(player, objectiveId)
	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	if not objective then return false end

	-- Mark as completed
	table.insert(research.CompletedObjectives, objectiveId)

	-- Remove from active
	local index = table.find(research.ActiveObjectives, objectiveId)
	if index then
		table.remove(research.ActiveObjectives, index)
	end

	-- Give rewards
	local tokenReward = objective.Rewards.ResearchTokens or 0
	if tokenReward > 0 then
		player.ResearchTokens.Value = player.ResearchTokens.Value + tokenReward
	end

	-- Unlock machines
	local unlockedMachines = {}
	if objective.Rewards.UnlockMachines then
		for _, machineId in pairs(objective.Rewards.UnlockMachines) do
			local itemKey = tostring(machineId)
			if _G["global_data"][player.Name]["Items"][itemKey] then
				_G["global_data"][player.Name]["Items"][itemKey]["Unlocked"] = true

				-- Get the machine name for the notification
				local machineName = getItemNameFromId(machineId)
				table.insert(unlockedMachines, machineName)
			end
		end
	end

	-- Build notification message (client will automatically split at "completed!" and style the reward text in blue)
	local notificationMessage = objective.Name .. " completed!"

	if tokenReward > 0 then
		notificationMessage = notificationMessage .. " +" .. tokenReward .. " Research Tokens"
	elseif #unlockedMachines > 0 then
		notificationMessage = notificationMessage .. " ðŸ”“ Unlocked: " .. table.concat(unlockedMachines, ", ")
	end

	-- Notify player
	RepStorage.Events.MessageClient:FireClient(player, "screen", {
		["message"] = notificationMessage
	})

	return true
end

-- Get player's research data
function ResearchHandler.GetPlayerResearch(player)
	ResearchHandler.InitializePlayer(player)
	return _G["global_data"][player.Name]["Research"]
end

return ResearchHandler
