local ServerStorage = game:GetService("ServerStorage")
local RepStorage = game:GetService("ReplicatedStorage")
local ResearchData = require(ServerStorage.Modules.ResearchData)

local ResearchHandler = {}

-- Initialize player research data if it doesn't exist
function ResearchHandler.InitializePlayer(player)
	if not _G["global_data"][player.Name]["Research"] then
		print("Initializing research data for", player.Name)
		_G["global_data"][player.Name]["Research"] = {
			CompletedObjectives = {},
			ActiveObjectives = {},
			ObjectiveProgress = {},
		}
	end
end

-- Start tracking an objective
function ResearchHandler.StartObjective(player, objectiveId)
	ResearchHandler.InitializePlayer(player)

	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	--print("=== START OBJECTIVE ===")
	--print("Player:", player.Name)
	--print("Objective ID:", objectiveId)
	--print("Objective found:", objective ~= nil)

	if not objective then
		warn("Objective", objectiveId, "not found!")
		return false
	end

	-- Check if already completed
	if table.find(research.CompletedObjectives, objectiveId) then
		--print("Already completed")
		return false, "Already completed"
	end

	-- Check if already active
	if table.find(research.ActiveObjectives, objectiveId) then
		--print("Already active")
		return false, "Already active"
	end

	-- Check prerequisites
	if not ResearchData.CanStartObjective(objectiveId, research.CompletedObjectives) then
		--print("Prerequisites not met")
		return false, "Prerequisites not met"
	end

	-- Start the objective
	table.insert(research.ActiveObjectives, objectiveId)
	research.ObjectiveProgress[tostring(objectiveId)] = {}

	-- Initialize progress for each requirement
	for _, requirement in pairs(objective.Requirements) do
		research.ObjectiveProgress[tostring(objectiveId)][requirement.ItemName] = 0
		--print("Initialized requirement:", requirement.ItemName, "= 0 /", requirement.Amount)
	end

	--print("Objective started successfully!")
	--print("Active objectives:", table.concat(research.ActiveObjectives, ", "))

	return true
end

-- Deposit an item towards an objective
function ResearchHandler.DepositItem(player, objectiveId, itemName, amount)
	ResearchHandler.InitializePlayer(player)

	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	--print("=== DEPOSIT ITEM ===")
	--print("Player:", player.Name)
	--print("Objective ID:", objectiveId)
	--print("Objective found:", objective ~= nil)print("Item Name:", itemName)
	--print("Amount:", amount)

	if not objective then 
		--print("Objective not found!")
		return false 
	end

	-- Check if objective is active
	if not table.find(research.ActiveObjectives, objectiveId) then
		--print("Objective not active!")
		--print("Active objectives:", table.concat(research.ActiveObjectives, ", "))
		return false, "Objective not active"
	end

	-- Find the requirement
	local requirement = nil
	for _, req in pairs(objective.Requirements) do
		--print("Checking requirement:", req.ItemName, "vs", itemName)
		if req.ItemName == itemName then
			requirement = req
			break
		end
	end

	if not requirement then
		--print("Item not required for this objective!")
		--print("Required items:")
		for _, req in pairs(objective.Requirements) do
			--print(" -", req.ItemName)
		end
		return false, "Item not required for this objective"
	end

	--print("Requirement found:", requirement.ItemName, requirement.Amount)

	-- Add to progress
	local currentProgress = research.ObjectiveProgress[tostring(objectiveId)][itemName] or 0
	local newProgress = math.min(currentProgress + amount, requirement.Amount)
	research.ObjectiveProgress[tostring(objectiveId)][itemName] = newProgress

	--print("Progress updated:", currentProgress, "->", newProgress)

	-- Check if objective is complete
	local isComplete = ResearchHandler.CheckObjectiveComplete(player, objectiveId)

	--print("Objective complete?", isComplete)

	if isComplete then
		ResearchHandler.CompleteObjective(player, objectiveId)
	end

	return true, newProgress
end

-- Check if an objective is complete
function ResearchHandler.CheckObjectiveComplete(player, objectiveId)
	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	if not objective or not research.ObjectiveProgress[tostring(objectiveId)] then
		return false
	end

	-- Check all requirements
	for _, requirement in pairs(objective.Requirements) do
		local progress = research.ObjectiveProgress[tostring(objectiveId)][requirement.ItemName] or 0
		if progress < requirement.Amount then
			return false
		end
	end

	return true
end

-- Complete an objective and give rewards
function ResearchHandler.CompleteObjective(player, objectiveId)
	local research = _G["global_data"][player.Name]["Research"]
	local objective = ResearchData.GetObjective(objectiveId)

	-- print("=== COMPLETING OBJECTIVE ===")
	--print("Objective:", objective.Name)

	if not objective then return false end

	-- Mark as completed
	table.insert(research.CompletedObjectives, objectiveId)

	-- Remove from active
	local index = table.find(research.ActiveObjectives, objectiveId)
	if index then
		table.remove(research.ActiveObjectives, index)
	end

	-- Give rewards
	if objective.Rewards.ResearchTokens then
		player.ResearchTokens.Value = player.ResearchTokens.Value + objective.Rewards.ResearchTokens
		--print("Gave", objective.Rewards.ResearchTokens, "research tokens")
	end

	-- Unlock machines
	if objective.Rewards.UnlockMachines then
		for _, machineId in pairs(objective.Rewards.UnlockMachines) do
			local itemKey = tostring(machineId)
			if _G["global_data"][player.Name]["Items"][itemKey] then
				_G["global_data"][player.Name]["Items"][itemKey]["Unlocked"] = true
				--print("Unlocked machine ID:", machineId)
			end
		end
	end

	-- Notify player with research name (no emoji, space before + for proper splitting)
	RepStorage.Events.MessageClient:FireClient(player, "screen", {
		["message"] = objective.Name .. " completed! +" .. (objective.Rewards.ResearchTokens or 0) .. " Research Tokens"
	})

	--print("Objective completed successfully!")

	return true
end

-- Get player's research data
function ResearchHandler.GetPlayerResearch(player)
	ResearchHandler.InitializePlayer(player)
	return _G["global_data"][player.Name]["Research"]
end

return ResearchHandler
