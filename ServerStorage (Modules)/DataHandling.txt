-- ServerStorage (Modules)/DataHandling.txt (UPDATED WITH ASSEMBLY CONFIG)

-- Services
local RepStorage = game:GetService("ReplicatedStorage")
-- Modules
local MainLib = require(RepStorage.Modules.MainLib)
-- DataHandling
local DataHandling = {}

local function LOAD_ITEM_BASICS(ITEM)
	-- ADD THIS: Add layer information when loading items
	if ITEM:FindFirstChild("ItemStats") then
		local itemStats = require(ITEM.ItemStats)

		-- Add PlacementLayer if it doesn't exist
		if not ITEM:FindFirstChild("PlacementLayer") then
			local layerValue = Instance.new("IntValue", ITEM)
			layerValue.Name = "PlacementLayer"

			if type(itemStats.PlacementLayer) == "table" then
				-- If multiple layers, store as a string
				layerValue.Value = itemStats.PlacementLayer[1]
				local layersString = Instance.new("StringValue", ITEM)
				layersString.Name = "PlacementLayers"
				layersString.Value = table.concat(itemStats.PlacementLayer, ",")
			else
				layerValue.Value = itemStats.PlacementLayer or 1
			end
		end
	end

	for I, DESCENDANT in pairs(ITEM:GetDescendants()) do
		if DESCENDANT:IsA("Script") then
			DESCENDANT.Disabled = DESCENDANT:FindFirstChild("ForceDisabled")
		end
		if I%50 == 0 then
			wait()
		end
	end
end

function DataHandling.LOAD_PLOT(Plr, PLOT_DATA)
	Plr:WaitForChild("SetPlot")
	local PLR_PLOT = Plr.SetPlot.Value
	for I, item_data in pairs(PLOT_DATA) do
		if item_data["item_pos"] then
			local ITEM_MODEL = MainLib.ITEM_FROM_ID(item_data["ITEM_ID"])
			if ITEM_MODEL.PrimaryPart ~= ITEM_MODEL.Hitbox then
				ITEM_MODEL.PrimaryPart = ITEM_MODEL.Hitbox
			end
			ITEM_MODEL = ITEM_MODEL:Clone()
			local item_pos = PLR_PLOT.BasePlot.CFrame * CFrame.new(unpack(item_data["item_pos"]))
			ITEM_MODEL:SetPrimaryPartCFrame(item_pos)

			-- NEW: Apply conveyor reversal if saved (UPDATED TO INCLUDE ConvSlope)
			if item_data["CONVEYOR_REVERSED"] then
				ITEM_MODEL:SetAttribute("ConveyorReversed", true)

				-- Reverse ConvVelo values BEFORE parenting/enabling scripts
				for _, descendant in pairs(ITEM_MODEL:GetDescendants()) do
					-- UPDATE: Handle Conv AND ConvSlope (NOT ConvMerge)
					if descendant:IsA("BasePart") and (descendant.Name == "Conv" or descendant.Name == "ConvSlope") then
						-- Skip ConvMerge (it has NoFlip attribute)
						if descendant:GetAttribute("NoFlip") then
							continue
						end

						local convVelo = descendant:FindFirstChild("ConvVelo")
						if convVelo then
							convVelo.Value = -convVelo.Value
							print("Loaded reversed ConvVelo for", descendant.Name, ":", convVelo.Value)
						end

						-- Reverse beam texture
						local beam = descendant:FindFirstChildOfClass("Beam")
						if beam then
							beam.TextureSpeed = -beam.TextureSpeed
							print("Loaded reversed Beam for", descendant.Name, ":", beam.TextureSpeed)
						end
					end
				end
			end

			-- NEW: Restore sorter configuration if saved
			if item_data["SORT_CONFIG"] then
				print("Loading sorter config for", ITEM_MODEL.Name)

				-- Get or create SortConfig folder
				local sortConfig = ITEM_MODEL:FindFirstChild("SortConfig")
				if not sortConfig then
					sortConfig = Instance.new("Folder")
					sortConfig.Name = "SortConfig"
					sortConfig.Parent = ITEM_MODEL
				end

				-- Restore each ore's sort direction
				for oreName, direction in pairs(item_data["SORT_CONFIG"]) do
					local config = Instance.new("StringValue")
					config.Name = oreName
					config.Value = direction
					config.Parent = sortConfig
					print("Restored:", oreName, "->", direction)
				end
			end

			-- ✨ NEW: Restore assembly machine configuration if saved
			if item_data["ASSEMBLY_CONFIG"] then
				print("Loading assembly config for", ITEM_MODEL.Name)

				local assemblyConfig = ITEM_MODEL:FindFirstChild("AssemblyConfig")
				if not assemblyConfig then
					assemblyConfig = Instance.new("StringValue")
					assemblyConfig.Name = "AssemblyConfig"
					assemblyConfig.Parent = ITEM_MODEL
				end

				assemblyConfig.Value = item_data["ASSEMBLY_CONFIG"]
				print("Restored assembly config:", assemblyConfig.Value)
			end

			ITEM_MODEL.Parent = PLR_PLOT.PlacedItems
			LOAD_ITEM_BASICS(ITEM_MODEL)
		else
			_G["global_data"][Plr.Name]["Items"][item_data["ITEM_ID"]].Amount += 1
		end
	end
end

function DataHandling.UNLOAD_PLOT(Plr)
	if Plr:FindFirstChild("SetPlot") then
		local PLR_PLOT = Plr.SetPlot.Value
		local PLOT_DATA = {}
		for I, ITEM in pairs(PLR_PLOT.PlacedItems:GetChildren()) do
			if ITEM:FindFirstChild("Hitbox") and ITEM:FindFirstChild("ItemStats") then

				-- ✨ SKIP HOTSPOT ITEMS - DON'T SAVE THEM!
				if ITEM:GetAttribute("HotspotMiner") == true then
					print("Skipping hotspot miner:", ITEM.Name)
					continue  -- Don't save hotspot miners
				end

				if ITEM:GetAttribute("HotspotFurnace") == true then
					print("Skipping hotspot furnace:", ITEM.Name)
					continue  -- Don't save hotspot furnaces
				end

				-- Normal items - save them with all their data
				local ITEM_INFO = require(ITEM.ItemStats)
				local itemData = {
					["ITEM_ID"] = ITEM_INFO.ItemId,
					["item_pos"] = {(PLR_PLOT.BasePlot.CFrame:Inverse() * ITEM.PrimaryPart.CFrame):components()}
				}

				-- Save conveyor reversal state
				if ITEM:GetAttribute("ConveyorReversed") then
					itemData["CONVEYOR_REVERSED"] = true
				end

				-- Save sorter configuration
				local sortConfig = ITEM:FindFirstChild("SortConfig")
				if sortConfig then
					print("Saving sorter config for", ITEM.Name)

					local configData = {}
					for _, config in pairs(sortConfig:GetChildren()) do
						if config:IsA("StringValue") then
							configData[config.Name] = config.Value
							print("Saved:", config.Name, "->", config.Value)
						end
					end

					-- Only save if there's actual config data
					if next(configData) then
						itemData["SORT_CONFIG"] = configData
					end
				end

				-- Save assembly machine configuration
				local assemblyConfig = ITEM:FindFirstChild("AssemblyConfig")
				if assemblyConfig and assemblyConfig:IsA("StringValue") then
					print("Saving assembly config for", ITEM.Name, ":", assemblyConfig.Value)
					itemData["ASSEMBLY_CONFIG"] = assemblyConfig.Value
				end

				PLOT_DATA[#PLOT_DATA+1] = itemData
			end
		end
		return PLOT_DATA
	end
end

return DataHandling
