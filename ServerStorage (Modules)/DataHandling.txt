-- Services
local RepStorage = game:GetService("ReplicatedStorage")
-- Modules
local MainLib = require(RepStorage.Modules.MainLib)
-- DataHandling
local DataHandling = {}

local function LOAD_ITEM_BASICS(ITEM)
	-- ADD THIS: Add layer information when loading items
	if ITEM:FindFirstChild("ItemStats") then
		local itemStats = require(ITEM.ItemStats)

		-- Add PlacementLayer if it doesn't exist
		if not ITEM:FindFirstChild("PlacementLayer") then
			local layerValue = Instance.new("IntValue", ITEM)
			layerValue.Name = "PlacementLayer"

			if type(itemStats.PlacementLayer) == "table" then
				-- If multiple layers, store as a string
				layerValue.Value = itemStats.PlacementLayer[1]
				local layersString = Instance.new("StringValue", ITEM)
				layersString.Name = "PlacementLayers"
				layersString.Value = table.concat(itemStats.PlacementLayer, ",")
			else
				layerValue.Value = itemStats.PlacementLayer or 1
			end
		end
	end

	for I, DESCENDANT in pairs(ITEM:GetDescendants()) do
		if DESCENDANT:IsA("Script") then
			DESCENDANT.Disabled = DESCENDANT:FindFirstChild("ForceDisabled")
		end
		if I%50 == 0 then
			wait()
		end
	end
end

function DataHandling.LOAD_PLOT(Plr, PLOT_DATA)
	Plr:WaitForChild("SetPlot")
	local PLR_PLOT = Plr.SetPlot.Value
	for I, item_data in pairs(PLOT_DATA) do
		if item_data["item_pos"] then
			local ITEM_MODEL = MainLib.ITEM_FROM_ID(item_data["ITEM_ID"])
			if ITEM_MODEL.PrimaryPart ~= ITEM_MODEL.Hitbox then
				ITEM_MODEL.PrimaryPart = ITEM_MODEL.Hitbox
			end
			ITEM_MODEL = ITEM_MODEL:Clone()
			local item_pos = PLR_PLOT.BasePlot.CFrame * CFrame.new(unpack(item_data["item_pos"]))
			ITEM_MODEL:SetPrimaryPartCFrame(item_pos)

			-- NEW: Apply conveyor reversal if saved
			if item_data["CONVEYOR_REVERSED"] then
				ITEM_MODEL:SetAttribute("ConveyorReversed", true)

				-- Reverse ConvVelo values BEFORE parenting/enabling scripts
				for _, descendant in pairs(ITEM_MODEL:GetDescendants()) do
					if descendant:IsA("BasePart") and descendant.Name == "Conv" then
						local convVelo = descendant:FindFirstChild("ConvVelo")
						if convVelo then
							convVelo.Value = -convVelo.Value
						end

						-- NEW: Reverse beam texture
						local beam = descendant:FindFirstChildOfClass("Beam")
						if beam then
							beam.TextureSpeed = -beam.TextureSpeed
						end
					end
				end
			end

			-- NEW: Restore sorter configuration if saved
			if item_data["SORT_CONFIG"] then
				print("Loading sorter config for", ITEM_MODEL.Name)

				-- Get or create SortConfig folder
				local sortConfig = ITEM_MODEL:FindFirstChild("SortConfig")
				if not sortConfig then
					sortConfig = Instance.new("Folder")
					sortConfig.Name = "SortConfig"
					sortConfig.Parent = ITEM_MODEL
				end

				-- Restore each ore's sort direction
				for oreName, direction in pairs(item_data["SORT_CONFIG"]) do
					local config = Instance.new("StringValue")
					config.Name = oreName
					config.Value = direction
					config.Parent = sortConfig
					print("Restored:", oreName, "->", direction)
				end
			end

			ITEM_MODEL.Parent = PLR_PLOT.PlacedItems
			LOAD_ITEM_BASICS(ITEM_MODEL)
		else
			_G["global_data"][Plr.Name]["Items"][item_data["ITEM_ID"]].Amount += 1
		end
	end
end

function DataHandling.UNLOAD_PLOT(Plr)
	if Plr:FindFirstChild("SetPlot") then
		local PLR_PLOT = Plr.SetPlot.Value
		local PLOT_DATA = {}
		for I, ITEM in pairs(PLR_PLOT.PlacedItems:GetChildren()) do
			if ITEM:FindFirstChild("Hitbox") and ITEM:FindFirstChild("ItemStats") then
				-- SKIP HOTSPOT MINERS
				if ITEM:GetAttribute("HotspotMiner") ~= true then
					local ITEM_INFO = require(ITEM.ItemStats)
					local itemData = {
						["ITEM_ID"] = ITEM_INFO.ItemId,
						["item_pos"] = {(PLR_PLOT.BasePlot.CFrame:Inverse() * ITEM.PrimaryPart.CFrame):components()}
					}

					-- NEW: Save conveyor reversal state
					if ITEM:GetAttribute("ConveyorReversed") then
						itemData["CONVEYOR_REVERSED"] = true
					end

					-- NEW: Save sorter configuration
					local sortConfig = ITEM:FindFirstChild("SortConfig")
					if sortConfig then
						print("Saving sorter config for", ITEM.Name)

						local configData = {}
						for _, config in pairs(sortConfig:GetChildren()) do
							if config:IsA("StringValue") then
								configData[config.Name] = config.Value
								print("Saved:", config.Name, "->", config.Value)
							end
						end

						-- Only save if there's actual config data
						if next(configData) then
							itemData["SORT_CONFIG"] = configData
						end
					end

					PLOT_DATA[#PLOT_DATA+1] = itemData
				end
			end
		end
		return PLOT_DATA
	end
end

return DataHandling
