-- StarterPlayerScripts/AssemblyGui (MODERN RESPONSIVE VERSION)

local Players = game:GetService("Players")
local RepStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Create main config GUI
local configGui = Instance.new("ScreenGui")
configGui.Name = "AssemblyConfigGui"
configGui.ResetOnSpawn = false
configGui.Enabled = false
configGui.ScreenInsets = Enum.ScreenInsets.None  -- Disable safe insets
configGui.Parent = playerGui

-- Main frame with responsive sizing
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 0
mainFrame.ZIndex = 10
mainFrame.Parent = configGui

-- Function to update GUI size based on screen size
local function updateGuiSize()
	local viewport = workspace.CurrentCamera.ViewportSize
	local screenWidth = viewport.X

	-- If screen width is less than 900 pixels (mobile/small tablet), make GUI bigger
	if screenWidth < 900 then
		mainFrame.Size = UDim2.new(0.7, 0, 0.7, 0)  -- 90% width, 70% height on mobile
	else
		mainFrame.Size = UDim2.new(.4, 0, .4, 0)  -- 35% width, 55% height on desktop
	end
end

-- Update on initial load
updateGuiSize()

-- Update when screen size changes (device rotation, window resize)
workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(updateGuiSize)

-- Aspect ratio constraint
local aspectRatio = Instance.new("UIAspectRatioConstraint")
aspectRatio.AspectRatio = 0.95  -- Nearly square
aspectRatio.DominantAxis = Enum.DominantAxis.Height
aspectRatio.Parent = mainFrame

-- Blur/Glass effect background
local blur = Instance.new("Frame")
blur.Size = UDim2.new(1, 0, 1, 0)
blur.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
blur.BackgroundTransparency = 0.3
blur.BorderSizePixel = 0
blur.ZIndex = 11
blur.Parent = mainFrame

local blurCorner = Instance.new("UICorner")
blurCorner.CornerRadius = UDim.new(0, 14)
blurCorner.Parent = blur

-- Outer glow/shadow
local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(60, 60, 80)
stroke.Thickness = 2
stroke.Transparency = 0.5
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
stroke.Parent = mainFrame

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 14)
corner.Parent = mainFrame

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0.15, 0)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
titleBar.BackgroundTransparency = 0.3
titleBar.BorderSizePixel = 0
titleBar.ZIndex = 12
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 14)
titleCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(0.8, 0, 1, 0)
title.Position = UDim2.new(0.05, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "âš™ï¸ Configure Plate Processor"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.ZIndex = 13
title.Parent = titleBar

local titleConstraint = Instance.new("UITextSizeConstraint")
titleConstraint.MaxTextSize = 20
titleConstraint.MinTextSize = 12
titleConstraint.Parent = title

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0.11, 0, 1, 0)
closeButton.Position = UDim2.new(0.97, 0, 0.15, 0)
closeButton.AnchorPoint = Vector2.new(1, 0)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextScaled = true
closeButton.Font = Enum.Font.GothamBold
closeButton.ZIndex = 13
closeButton.Parent = titleBar

local closeSizeConstraint = Instance.new("UITextSizeConstraint")
closeSizeConstraint.MaxTextSize = 24
closeSizeConstraint.MinTextSize = 8
closeSizeConstraint.Parent = closeButton

local closeAspect = Instance.new("UIAspectRatioConstraint")
closeAspect.AspectRatio = 1
closeAspect.Parent = closeButton

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0.25, 0)
closeCorner.Parent = closeButton

-- Description
local descLabel = Instance.new("TextLabel")
descLabel.Size = UDim2.new(0.9, 0, 0.1, 0)
descLabel.Position = UDim2.new(0.05, 0, 0.14, 0)
descLabel.BackgroundTransparency = 1
descLabel.Text = "Choose what to produce from plates:"
descLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
descLabel.TextScaled = true
descLabel.Font = Enum.Font.Gotham
descLabel.TextXAlignment = Enum.TextXAlignment.Left
descLabel.TextWrapped = true
descLabel.ZIndex = 12
descLabel.Parent = mainFrame

local descConstraint = Instance.new("UITextSizeConstraint")
descConstraint.MaxTextSize = 16
descConstraint.MinTextSize = 10
descConstraint.Parent = descLabel

-- Options container
local optionsFrame = Instance.new("Frame")
optionsFrame.Size = UDim2.new(0.9, 0, 0.6, 0)
optionsFrame.Position = UDim2.new(0.05, 0, 0.24, 0)
optionsFrame.BackgroundTransparency = 1
optionsFrame.ZIndex = 12
optionsFrame.Parent = mainFrame

local optionsLayout = Instance.new("UIListLayout")
optionsLayout.Padding = UDim.new(0.03, 0)
optionsLayout.SortOrder = Enum.SortOrder.LayoutOrder
optionsLayout.Parent = optionsFrame

-- Apply button
local applyButton = Instance.new("TextButton")
applyButton.Size = UDim2.new(0.9, 0, 0.16, 0)
applyButton.Position = UDim2.new(0.05, 0, 0.82, 0)
applyButton.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
applyButton.Text = "âœ“ Apply Settings"
applyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
applyButton.TextScaled = true
applyButton.Font = Enum.Font.GothamBold
applyButton.ZIndex = 13
applyButton.Parent = mainFrame

local applyTextConstraint = Instance.new("UITextSizeConstraint")
applyTextConstraint.MaxTextSize = 18
applyTextConstraint.MinTextSize = 12
applyTextConstraint.Parent = applyButton

local applyCorner = Instance.new("UICorner")
applyCorner.CornerRadius = UDim.new(0.2, 0)
applyCorner.Parent = applyButton

-- Current machine reference
local currentMachine = nil
local currentConfig = nil
local pendingSelection = nil

-- Output options
local outputOptions = {
	{Name = "Gear", Icon = "âš™ï¸", Color = Color3.fromRGB(31, 35, 126)},
	{Name = "Coil", Icon = "ðŸ”„", Color = Color3.fromRGB(31, 35, 126)},
	{Name = "Pipe", Icon = "ðŸ”§", Color = Color3.fromRGB(31, 35, 126)},
}

-- Function to create option button
local function createOptionButton(optionData)
	local button = Instance.new("TextButton")
	button.Name = optionData.Name .. "Button"
	button.Size = UDim2.new(1, 0, 0.28, 0)  -- Takes up about 1/3 of options space
	button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
	button.BorderSizePixel = 0
	button.Text = ""
	button.LayoutOrder = optionData.LayoutOrder or 1
	button.ZIndex = 13
	button.Parent = optionsFrame

	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(0, 12)
	btnCorner.Parent = button

	-- Icon
	local icon = Instance.new("TextLabel")
	icon.Size = UDim2.new(0.15, 0, 0.8, 0)
	icon.Position = UDim2.new(0.05, 0, 0.1, 0)
	icon.BackgroundTransparency = 1
	icon.Text = optionData.Icon
	icon.TextScaled = true
	icon.ZIndex = 14
	icon.Parent = button

	local iconConstraint = Instance.new("UITextSizeConstraint")
	iconConstraint.MaxTextSize = 35
	iconConstraint.MinTextSize = 20
	iconConstraint.Parent = icon

	-- Name
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(0.6, 0, 0.8, 0)
	nameLabel.Position = UDim2.new(0.22, 0, 0.1, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = optionData.Name
	nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	nameLabel.TextScaled = true
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.ZIndex = 14
	nameLabel.Parent = button

	local nameConstraint = Instance.new("UITextSizeConstraint")
	nameConstraint.MaxTextSize = 22
	nameConstraint.MinTextSize = 14
	nameConstraint.Parent = nameLabel

	-- Selected indicator
	local selectedIcon = Instance.new("TextLabel")
	selectedIcon.Name = "SelectedIcon"
	selectedIcon.Size = UDim2.new(0.12, 0, 0.6, 0)
	selectedIcon.Position = UDim2.new(0.86, 0, 0.2, 0)
	selectedIcon.BackgroundTransparency = 1
	selectedIcon.Text = "âœ“"
	selectedIcon.TextColor3 = Color3.fromRGB(100, 255, 100)
	selectedIcon.TextScaled = true
	selectedIcon.Font = Enum.Font.GothamBold
	selectedIcon.Visible = false
	selectedIcon.ZIndex = 14
	selectedIcon.Parent = button

	local selectedConstraint = Instance.new("UITextSizeConstraint")
	selectedConstraint.MaxTextSize = 30
	selectedConstraint.MinTextSize = 18
	selectedConstraint.Parent = selectedIcon

	-- Click handler - just update UI, don't save yet
	button.MouseButton1Click:Connect(function()
		if currentMachine and currentConfig then
			-- Store pending selection
			pendingSelection = optionData.Name

			print("Selected:", optionData.Name, "(not saved yet)")

			-- Update all buttons to show selection
			for _, btn in pairs(optionsFrame:GetChildren()) do
				if btn:IsA("TextButton") then
					local selectedIndicator = btn:FindFirstChild("SelectedIcon")
					if selectedIndicator then
						selectedIndicator.Visible = (btn.Name == optionData.Name .. "Button")
					end

					if btn.Name == optionData.Name .. "Button" then
						btn.BackgroundColor3 = optionData.Color
					else
						btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
					end
				end
			end
		end
	end)

	-- Hover effect
	button.MouseEnter:Connect(function()
		if button:FindFirstChild("SelectedIcon") and not button.SelectedIcon.Visible then
			button.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
		end
	end)

	button.MouseLeave:Connect(function()
		if button:FindFirstChild("SelectedIcon") and not button.SelectedIcon.Visible then
			button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
		end
	end)

	return button
end

-- Create option buttons
for i, option in ipairs(outputOptions) do
	option.LayoutOrder = i
	createOptionButton(option)
end

-- Function to load machine config
local function loadMachineConfig(machine)
	currentMachine = machine

	-- Get current config
	currentConfig = machine:FindFirstChild("AssemblyConfig")
	if not currentConfig then
		warn("Machine doesn't have AssemblyConfig!")
		return
	end

	print("Loading assembly config:", currentConfig.Value)

	-- Set pending selection to current config
	pendingSelection = currentConfig.Value

	-- Update button states
	for _, btn in pairs(optionsFrame:GetChildren()) do
		if btn:IsA("TextButton") then
			local selectedIndicator = btn:FindFirstChild("SelectedIcon")
			if selectedIndicator then
				local isSelected = (btn.Name == currentConfig.Value .. "Button")
				selectedIndicator.Visible = isSelected

				if isSelected then
					-- Find the matching option data for color
					for _, option in ipairs(outputOptions) do
						if btn.Name == option.Name .. "Button" then
							btn.BackgroundColor3 = option.Color
							break
						end
					end
				else
					btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
				end
			end
		end
	end

	-- Show GUI
	configGui.Enabled = true
end

-- Apply button handler
applyButton.MouseButton1Click:Connect(function()
	if currentMachine and currentConfig and pendingSelection then
		print("Applying settings:", pendingSelection)

		-- Send changes to server
		local success = RepStorage.Events.ConfigureAssembly:InvokeServer(currentMachine, pendingSelection)

		if success then
			print("Assembly machine configured to:", pendingSelection)

			-- Close GUI
			configGui.Enabled = false
			currentMachine = nil
			currentConfig = nil
			pendingSelection = nil
		else
			warn("Failed to apply settings!")
		end
	end
end)

-- Close button
closeButton.MouseButton1Click:Connect(function()
	configGui.Enabled = false
	currentMachine = nil
	currentConfig = nil
	pendingSelection = nil
end)

-- Create RemoteFunction for config
if not RepStorage.Events:FindFirstChild("ConfigureAssembly") then
	local remoteFunc = Instance.new("RemoteFunction")
	remoteFunc.Name = "ConfigureAssembly"
	remoteFunc.Parent = RepStorage.Events
end

-- Listen for proximity prompt triggers on existing machines
workspace.DescendantAdded:Connect(function(descendant)
	if descendant.Name == "AssemblyConfigPrompt" and descendant:IsA("ProximityPrompt") then
		descendant.Triggered:Connect(function(playerWhoTriggered)
			if playerWhoTriggered == player then
				local machine = descendant.Parent
				if machine and machine:FindFirstChild("ItemStats") then
					loadMachineConfig(machine)
				end
			end
		end)
	end
end)

-- Setup existing prompts
for _, descendant in pairs(workspace:GetDescendants()) do
	if descendant.Name == "AssemblyConfigPrompt" and descendant:IsA("ProximityPrompt") then
		descendant.Triggered:Connect(function(playerWhoTriggered)
			if playerWhoTriggered == player then
				local machine = descendant.Parent
				if machine and machine:FindFirstChild("ItemStats") then
					loadMachineConfig(machine)
				end
			end
		end)
	end
end

print("Assembly Machine GUI loaded!")
