print("=== MODERN MINER HOTSPOT CLIENT STARTING ===")

local Players = game:GetService("Players")
local RepStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local SoundManager = require(RepStorage.Modules.SoundManager)

print("Player found:", player.Name)

-- WAIT FOR DATA TO LOAD FIRST
print("Waiting for DataLoaded...")
local dataLoaded = player:WaitForChild("DataLoaded", 30)

if not dataLoaded then
	warn("DataLoaded tag not found - player data didn't load!")
	return
end

print("Data loaded! Now setting up hotspots...")

-- Wait for SetPlot
player:WaitForChild("SetPlot", 10)
local plot = player.SetPlot.Value

if not plot then
	warn("SetPlot.Value is nil!")
	return
end

print("Plot assigned:", plot.Name)

local hotspotFolder = plot:WaitForChild("MinerHotspots", 10)

if not hotspotFolder then
	warn("No MinerHotspots folder found in plot!")
	return
end

print("MinerHotspots folder found!")

-- Function to create modern UI elements
local function createModernHotspotUI(parent, info)
	local billboardGui = Instance.new("BillboardGui")
	billboardGui.Name = "BuyPrompt"
	billboardGui.Size = UDim2.new(0, 200, 0, 85)
	billboardGui.StudsOffset = Vector3.new(0, 5, 0)
	billboardGui.AlwaysOnTop = true
	billboardGui.MaxDistance = 50  -- Only visible within 25 studs
	billboardGui.Adornee = parent
	billboardGui.Parent = parent

	-- Main container with modern styling
	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 1, 0)
	container.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
	container.BackgroundTransparency = 0.1
	container.BorderSizePixel = 0
	container.ZIndex = 10
	container.Parent = billboardGui

	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 12)
	containerCorner.Parent = container

	-- Glass-morphism blur effect
	local blur = Instance.new("Frame")
	blur.Size = UDim2.new(1, 0, 1, 0)
	blur.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
	blur.BackgroundTransparency = 0.3
	blur.BorderSizePixel = 0
	blur.ZIndex = 11
	blur.Parent = container

	local blurCorner = Instance.new("UICorner")
	blurCorner.CornerRadius = UDim.new(0, 12)
	blurCorner.Parent = blur

	-- Outer glow/shadow
	local stroke = Instance.new("UIStroke")
	stroke.Color = Color3.fromRGB(60, 60, 80)
	stroke.Thickness = 2
	stroke.Transparency = 0.5
	stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	stroke.Parent = container

	-- Content frame
	local content = Instance.new("Frame")
	content.Size = UDim2.new(1, -16, 1, -16)
	content.Position = UDim2.new(0, 8, 0, 8)
	content.BackgroundTransparency = 1
	content.ZIndex = 12
	content.Parent = container

	-- Miner name (title)
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "TitleLabel"
	titleLabel.Size = UDim2.new(1, 0, 0, 20)
	titleLabel.Position = UDim2.new(0, 0, 0, 0)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Text = info.Config.MinerName
	titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	titleLabel.TextSize = 14
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.TextXAlignment = Enum.TextXAlignment.Center
	titleLabel.ZIndex = 13
	titleLabel.Parent = content

	-- Divider line
	local divider = Instance.new("Frame")
	divider.Size = UDim2.new(1, -10, 0, 1)
	divider.Position = UDim2.new(0, 5, 0, 24)
	divider.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
	divider.BackgroundTransparency = 0.5
	divider.BorderSizePixel = 0
	divider.ZIndex = 12
	divider.Parent = content

	-- Cost label with background for better visibility
	local costContainer = Instance.new("Frame")
	costContainer.Size = UDim2.new(1, -10, 0, 32)
	costContainer.Position = UDim2.new(0, 5, 0, 30)
	costContainer.BackgroundColor3 = Color3.fromRGB(50, 55, 65)
	costContainer.BorderSizePixel = 0
	costContainer.ZIndex = 12
	costContainer.Parent = content

	local costCorner = Instance.new("UICorner")
	costCorner.CornerRadius = UDim.new(0, 8)
	costCorner.Parent = costContainer

	local costStroke = Instance.new("UIStroke")
	costStroke.Color = Color3.fromRGB(0, 0, 0)
	costStroke.Thickness = 1
	costStroke.Transparency = 0.7
	costStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	costStroke.Parent = costContainer

	local costLabel = Instance.new("TextLabel")
	costLabel.Name = "CostLabel"
	costLabel.Size = UDim2.new(1, -10, 1, 0)
	costLabel.Position = UDim2.new(0, 5, 0, 0)
	costLabel.BackgroundTransparency = 1
	costLabel.ZIndex = 13
	costLabel.Font = Enum.Font.GothamBold
	costLabel.TextSize = 14
	costLabel.TextXAlignment = Enum.TextXAlignment.Center
	costLabel.Parent = costContainer

	if info.Config.Cost == 0 then
		costLabel.Text = "‚ú® FREE!"
		costLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
	else
		costLabel.Text = "üî¨ " .. info.Config.Cost .. " Tokens"
		costLabel.TextColor3 = Color3.fromRGB(134, 207, 255)
	end

	-- Function to reset cost display
	local function resetCostDisplay()
		if info.Config.Cost == 0 then
			costLabel.Text = "‚ú® FREE!"
			costLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
		else
			costLabel.Text = "üî¨ " .. info.Config.Cost .. " Tokens"
			costLabel.TextColor3 = Color3.fromRGB(134, 207, 255)
		end
	end

	-- Subtle pulse animation for cost container
	local pulseInfo = TweenInfo.new(
		1.5,
		Enum.EasingStyle.Sine,
		Enum.EasingDirection.InOut,
		-1,
		true
	)
	local pulseTween = TweenService:Create(costStroke, pulseInfo, {
		Transparency = 0.4
	})
	pulseTween:Play()

	return billboardGui, costLabel, costContainer, pulseTween, resetCostDisplay
end

-- Function to setup a hotspot
local function setupHotspot(hotspot)
	print("=== Setting up hotspot:", hotspot.Name, "===")

	local hotspotId = hotspot:WaitForChild("HotspotId", 5)
	if not hotspotId then 
		warn("No HotspotId in", hotspot.Name, "after timeout")
		return 
	end

	print("HotspotId:", hotspotId.Value)

	local buyButton = hotspot:WaitForChild("BuyButton", 10)
	if not buyButton then 
		warn("No BuyButton in", hotspot.Name, "after timeout")
		return 
	end

	print("BuyButton found! Type:", buyButton.ClassName)

	if not RepStorage.Events:FindFirstChild("GetHotspotInfo") then
		warn("GetHotspotInfo RemoteFunction not found!")
		return
	end

	print("Calling GetHotspotInfo...")

	local success, info = pcall(function()
		return RepStorage.Events.GetHotspotInfo:InvokeServer(hotspotId.Value)
	end)

	if not success then
		warn("Error calling GetHotspotInfo:", info)
		return
	end

	if not info or not info.Config then
		warn("No config returned for hotspot", hotspotId.Value)
		return
	end

	print("Got hotspot info - Miner:", info.Config.MinerName, "Cost:", info.Config.Cost, "Unlocked:", info.IsUnlocked)

	local ghostMiner = nil

	if not info.IsUnlocked then
		print("Creating ghost miner...")

		local minerModel = RepStorage.Items:FindFirstChild(info.Config.MinerName)

		if not minerModel then
			warn("Miner model not found:", info.Config.MinerName)
		else
			ghostMiner = minerModel:Clone()
			ghostMiner.Name = "GhostMiner"

			for _, descendant in pairs(ghostMiner:GetDescendants()) do
				if descendant:IsA("BasePart") then
					if descendant.Name == "Hitbox" then
						descendant.Transparency = 1
					else
						descendant.Transparency = 0.7
					end
					descendant.CanCollide = false
					descendant.Anchored = true
				end
			end

			local positionPart = hotspot:WaitForChild("Position", 5)
			if positionPart then
				ghostMiner:SetPrimaryPartCFrame(positionPart.CFrame)
				print("Ghost miner positioned")
			else
				warn("No Position part in", hotspot.Name)
			end

			ghostMiner.Parent = hotspot
			print("Ghost miner created!")
		end

		print("Creating modern BillboardGui...")

		-- Create modern UI
		local billboardGui, costLabel, costContainer, pulseTween, resetCostDisplay = createModernHotspotUI(buyButton, info)

		print("Modern BillboardGui created!")

		-- Wait for or create ProximityPrompt
		local proximityPrompt = buyButton:FindFirstChild("UnlockPrompt")
		if not proximityPrompt then
			print("Creating ProximityPrompt...")
			proximityPrompt = Instance.new("ProximityPrompt")
			proximityPrompt.Name = "UnlockPrompt"
			proximityPrompt.ActionText = "Unlock Hotspot"
			proximityPrompt.ObjectText = info.Config.MinerName
			proximityPrompt.KeyboardKeyCode = Enum.KeyCode.E
			proximityPrompt.MaxActivationDistance = 10
			proximityPrompt.RequiresLineOfSight = false
			proximityPrompt.Parent = buyButton
		end

		-- Handle ProximityPrompt trigger
		proximityPrompt.Triggered:Connect(function(playerWhoTriggered)
			print("=== PROXIMITY PROMPT TRIGGERED ===")
			print("Triggered by:", playerWhoTriggered.Name)

			if playerWhoTriggered ~= player then 
				print("Not the local player, ignoring")
				return 
			end

			print("Processing unlock for hotspot", hotspotId.Value)

			-- Stop pulse animation
			pulseTween:Pause()

			local success, result, errorMsg = pcall(function()
				return RepStorage.Events.UnlockMinerHotspot:InvokeServer(hotspotId.Value)
			end)

			if not success then
				warn("Error calling UnlockMinerHotspot:", result)
				costLabel.Text = "‚ùå Error!"
				costLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
				task.wait(1.5)
				resetCostDisplay()
				pulseTween:Play()
				return
			end

			print("Server response:", result, errorMsg)

			if result == true then
				print("Hotspot unlocked successfully!")
				costLabel.Text = "‚úì Unlocked!"
				costLabel.TextColor3 = Color3.fromRGB(100, 255, 100)

				-- Fade out animation
				local fadeInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
				local fadeTween = TweenService:Create(billboardGui.Frame, fadeInfo, {
					BackgroundTransparency = 1
				})
				fadeTween:Play()

				task.wait(0.5)

				-- Destroy both the billboard AND the ghost miner
				billboardGui:Destroy()

				if ghostMiner and ghostMiner.Parent then
					print("Destroying ghost miner...")
					ghostMiner:Destroy()
				end

				print("Cleanup complete!")
			else
				-- Handle failure - check for specific error message
				warn("Failed to unlock:", errorMsg or result)

				-- Display specific error message
				if errorMsg == "Not enough tokens" then
					SoundManager.Error()
					costLabel.Text = "Not enough tokens!"
				elseif errorMsg == "Already unlocked" then
					costLabel.Text = "‚úì Already unlocked!"
				elseif errorMsg then
					costLabel.Text = "‚ùå " .. errorMsg
				else
					costLabel.Text = "‚ùå Cannot unlock!"
				end

				costLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
				task.wait(2)
				resetCostDisplay()
				pulseTween:Play()
			end
		end)

		print("ProximityPrompt handler connected!")
		print("Setup complete for", hotspot.Name)
	else
		print("Hotspot already unlocked")
	end
end

print("Setting up hotspots...")

for _, hotspot in pairs(hotspotFolder:GetChildren()) do
	task.spawn(function()
		local success, err = pcall(function()
			setupHotspot(hotspot)
		end)

		if not success then
			warn("Error setting up", hotspot.Name, ":", err)
		end
	end)
end

print("=== MODERN MINER HOTSPOT CLIENT LOADED ===")
