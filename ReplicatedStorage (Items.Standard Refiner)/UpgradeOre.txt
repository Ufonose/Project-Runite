local ORIG_COLOR = script.Parent.Upgrade.Color
local RepStorage = game:GetService("ReplicatedStorage")
local ITEM_HANDLER = require(RepStorage.Modules.ItemHandler)
local ITEM_INFO = require(script.Parent.Parent.ItemStats)
local PLOT = script.Parent.Parent.Parent.Parent

local function refineOre(ORE)
	print("=== REFINE ORE CALLED ===")
	print("Ore Name:", ORE.Name)
	print("Ore Type:", ORE.ClassName)

	-- Get the original ore model name
	local oreModelTag = ORE:FindFirstChild("OreModelName")
	if not oreModelTag then
		warn("Ore doesn't have OreModelName tag! Cannot refine.")
		return ORE
	end

	local originalModelName = oreModelTag.Value
	print("Original model name:", originalModelName)

	-- Check if this ore is already refined
	if string.find(originalModelName, "_Refined") then
		print("Ore is already refined, skipping")
		return ORE
	end

	-- Look for the refined version
	local oreFolder = RepStorage:FindFirstChild("OreModels")
	if not oreFolder then
		warn("OreModels folder not found!")
		return ORE
	end

	local refinedModelName = originalModelName .. "_Refined"
	print("Looking for refined model:", refinedModelName)

	local refinedModel = oreFolder:FindFirstChild(refinedModelName)

	if not refinedModel then
		warn("Refined model '" .. refinedModelName .. "' not found in OreModels folder!")
		print("Available models in OreModels:")
		for _, model in pairs(oreFolder:GetChildren()) do
			print(" -", model.Name)
		end
		return ORE
	end

	-- Check if refined version is a Model (requires PrimaryPart) or single BasePart
	if refinedModel:IsA("Model") and not refinedModel.PrimaryPart then
		warn(refinedModelName .. " is a Model but does not have a PrimaryPart set!")
		return ORE
	end

	print("Found refined model! Swapping...")

	-- Clone the refined model
	local newOre = refinedModel:Clone()
	newOre.Name = ORE.Name -- Keep the mine name

	-- Tag the new ore with the refined model name
	local newOreModelTag = Instance.new("StringValue", newOre)
	newOreModelTag.Name = "OreModelName"
	newOreModelTag.Value = refinedModelName

	-- Copy the Cash value
	if ORE:FindFirstChild("Cash") then
		local cashValue = Instance.new("NumberValue", newOre)
		cashValue.Name = "Cash"
		cashValue.Value = ORE.Cash.Value
		print("Cash value copied:", cashValue.Value)
	end

	-- Copy any upgrade tags (for upgrade limits)
	for _, child in pairs(ORE:GetChildren()) do
		if child:IsA("NumberValue") and child.Name ~= "Cash" then
			local tag = child:Clone()
			tag.Parent = newOre
			print("Copied tag:", tag.Name, "Value:", tag.Value)
		end
	end

	-- UPDATED: Position the new refined ore AHEAD of the refiner to avoid double-refining
	-- Get the conveyor direction (assuming the ore is moving along the conveyor)
	local upgradePartCFrame = script.Parent.Upgrade.CFrame
	local offset = upgradePartCFrame.LookVector * (script.Parent.Upgrade.Size.Z + 3) -- Move it past the upgrade part

	-- Position based on whether it's a Model or single BasePart
	if ORE:IsA("Model") then
		-- Old ore is a Model
		local oldPosition = ORE:GetPivot()
		local newPosition = oldPosition + offset

		if newOre:IsA("Model") then
			-- Both Model -> Model
			newOre:PivotTo(newPosition)
		else
			-- Model -> BasePart
			newOre.CFrame = newPosition
		end
	else
		-- Old ore is a BasePart
		local oldPosition = ORE.CFrame
		local newPosition = oldPosition + offset

		if newOre:IsA("Model") then
			-- BasePart -> Model
			newOre:PivotTo(newPosition)
		else
			-- Both BasePart -> BasePart
			newOre.CFrame = newPosition
		end
	end

	-- Parent it to the same location
	newOre.Parent = ORE.Parent

	-- Destroy the old ore
	ORE:Destroy()

	print("Refinement complete!")
	return newOre
end

script.Parent.Upgrade.Touched:Connect(function(HIT)
	local ORE = nil

	-- Check if the hit part itself has Cash (old system - single part)
	if HIT:FindFirstChild("Cash") then
		ORE = HIT
	else
		-- Check if the hit part's parent is a model with Cash (new system - model)
		if HIT.Parent and HIT.Parent:IsA("Model") and HIT.Parent:FindFirstChild("Cash") then
			ORE = HIT.Parent
		end
	end

	-- Upgrade the ore if we found one
	if ORE and ORE:FindFirstChild("Cash") then
		local UPGRADE_ORE = ITEM_HANDLER.UPGRADE_ORE(PLOT, script.Parent.Parent, ORE, ITEM_INFO.Addition, ITEM_INFO.Multiplier, ITEM_INFO.ItemId, 30)
		if UPGRADE_ORE == true then
			print("Ore upgraded successfully, now refining...")
			-- Successfully upgraded - now refine it visually!
			ORE = refineOre(ORE)
		elseif UPGRADE_ORE == false then
			-- Hit the upgrade limit, flash gray
			script.Parent.Upgrade.Color = Color3.fromRGB(99, 99, 99)
			wait(.2)
			script.Parent.Upgrade.Color = ORIG_COLOR
		end
	end
end)
