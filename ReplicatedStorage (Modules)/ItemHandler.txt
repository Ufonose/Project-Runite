-- ReplicatedStorage (Modules)/ItemHandler.txt (MODIFIED FOR RARITY SYSTEM)

-- Services
local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Plrs = game:GetService("Players")
local PhysicsService = game:GetService("PhysicsService")

-- Item Handling
local module = {}

-- CREATE COLLISION GROUP ON MODULE LOAD
local success = pcall(function()
	PhysicsService:RegisterCollisionGroup("Ores")
	PhysicsService:CollisionGroupSetCollidable("Ores", "Ores", false)
end)

if success then
	print("âœ“ Ore collision group created successfully!")
end

function module.GET_REAL_TIER(ITEM_INFO)
	return ITEM_INFO.TierId  -- Just use what you set!
end

-- MODIFIED: Added optional CUSTOM_ORE_NAME parameter for rarity system
function module.DROP_ORE(PLOT, MINE, DROP_PART, ORE_SIZE, ORE_COLOR, ORE_MATERIAL, ORE_WORTH, CUSTOM_ORE_NAME)
	local PLOT_OWNER = Plrs:FindFirstChild(PLOT.Owner.Value)
	if PLOT_OWNER then
		-- Get the mine info to find the custom model name
		local MINE_INFO = require(MINE.ItemStats)
		-- NEW: Use custom ore name if provided, otherwise fall back to ItemStats
		local modelName = CUSTOM_ORE_NAME or MINE_INFO.OreModelName or "StoneOreModel"

		-- Look for ore models in the OreModels folder
		local oreFolder = RepStorage:FindFirstChild("OreModels")
		if not oreFolder then
			warn("OreModels folder not found in ReplicatedStorage!")
			return nil, nil
		end

		local ORE_TEMPLATE = oreFolder:FindFirstChild(modelName)
		if not ORE_TEMPLATE then
			warn("Ore model '" .. modelName .. "' not found in OreModels folder!")
			return nil, nil
		end

		local ORE
		local CASH_VALUE

		-- Check if it's a Model or a single Part
		if ORE_TEMPLATE:IsA("Model") then
			-- EXISTING MODEL LOGIC
			if not ORE_TEMPLATE.PrimaryPart then
				warn(modelName .. " does not have a PrimaryPart set!")
				return nil, nil
			end

			-- Clone the model
			ORE = ORE_TEMPLATE:Clone()
			ORE.Name = MINE.Name

			-- Store the original ore model name for refinement
			local oreModelTag = Instance.new("StringValue", ORE)
			oreModelTag.Name = "OreModelName"
			oreModelTag.Value = modelName

			-- Add the cash value to the model
			CASH_VALUE = Instance.new("NumberValue", ORE)
			CASH_VALUE.Name = "Cash"
			CASH_VALUE.Value = ORE_WORTH

			-- Set collision group for all parts (NO COLLISIONFIDELITY!)
			for _, part in pairs(ORE:GetDescendants()) do
				if part:IsA("BasePart") then
					part.CollisionGroup = "Ores"
				end
			end

			-- Position the ore at the drop point
			ORE:PivotTo(DROP_PART.CFrame)

		elseif ORE_TEMPLATE:IsA("BasePart") then
			-- NEW SINGLE PART LOGIC
			ORE = ORE_TEMPLATE:Clone()
			ORE.Name = MINE.Name

			-- Store the original ore model name for refinement
			local oreModelTag = Instance.new("StringValue", ORE)
			oreModelTag.Name = "OreModelName"
			oreModelTag.Value = modelName

			-- Add the cash value to the part
			CASH_VALUE = Instance.new("NumberValue", ORE)
			CASH_VALUE.Name = "Cash"
			CASH_VALUE.Value = ORE_WORTH

			-- Set collision group (NO COLLISIONFIDELITY!)
			ORE.CollisionGroup = "Ores"

			-- Position the ore at the drop point
			ORE.CFrame = DROP_PART.CFrame
		else
			warn("Ore template '" .. modelName .. "' is neither a Model nor a BasePart!")
			return nil, nil
		end

		return ORE, CASH_VALUE
	end
	return nil, nil
end

function module.PROCESS_ORE(PLOT, FURNACE, SMELT_PART, ORE_ADD, ORE_MULTI, ORE)
	local PLOT_OWNER = Plrs:FindFirstChild(PLOT.Owner.Value)
	local OWNER_CASH = ServerStorage.ServerLockedPlayerInfo.PlayerCash:FindFirstChild(PLOT.Owner.Value)
	if PLOT_OWNER and OWNER_CASH then
		local CASH_VAL = ORE.Cash.Value
		if ORE_ADD > 0 then
			CASH_VAL += ORE_ADD
		end
		if ORE_MULTI > 0 then
			CASH_VAL *= ORE_MULTI
		end
		OWNER_CASH.Value += CASH_VAL
		RepStorage.Events.MessageClient:FireClient(PLOT_OWNER, "visual", {["visual_part"] = SMELT_PART, ["message"] = "+$"..CASH_VAL, ["message_color"] = Color3.fromRGB(85, 255, 127)})
		return true
	end
	return false
end

function module.UPGRADE_ORE(PLOT, UPGRADER, ORE, ORE_ADD, ORE_MULTI, TAG_NAME, LIMIT_USE)
	local PLOT_OWNER = Plrs:FindFirstChild(PLOT.Owner.Value)
	if ORE:FindFirstChild("Cash") then
		local TAG = ORE:FindFirstChild(TAG_NAME)
		if TAG then
			if TAG.Value > LIMIT_USE then
				return false
			end
		end
		if TAG == nil then
			TAG = Instance.new("NumberValue", ORE)
			TAG.Name = TAG_NAME
			TAG.Value = 0
		end
		TAG.Value += 1
		if ORE_MULTI > 0 then
			ORE.Cash.Value *= ORE_MULTI
		end
		if ORE_ADD > 0 then
			ORE.Cash.Value += ORE_ADD
		end
		return true
	end
	return false
end

function module.CONVEYOR_MOVE(CONVEYOR, SPEED)
	CONVEYOR.AssemblyLinearVelocity = CONVEYOR.CFrame.LookVector * SPEED
end

return module
