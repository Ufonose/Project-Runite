-- ServerScriptService/ItemHandler.lua
-- FIXED: Uses upgrade levels instead of multipliers

-- Services
local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- Move Items folder if needed
if workspace:FindFirstChild("Items") then
	workspace.Items.Parent = RepStorage
end

-- Load ConveyorUpgradeApplier
local ConveyorUpgradeApplier = require(ServerStorage:WaitForChild("Modules"):WaitForChild("ConveyorUpgradeApplier"))

-- Process all items in ReplicatedStorage
for I, ITEM in pairs(RepStorage.Items:GetChildren()) do
	local ITEM_INFO = require(ITEM.ItemStats)

	for E, ITEM_PART in pairs(ITEM:GetDescendants()) do
		-- Add ConvVelo to all conveyor types (Conv, ConvMerge, ConvSlope, ConvSlopeMerge)
		if (ITEM_PART.Name == "Conv" or ITEM_PART.Name == "ConvMerge" or ITEM_PART.Name == "ConvSlope" or ITEM_PART.Name == "ConvSlopeMerge") and ITEM_PART:IsA("BasePart") then
			local CONV_SPEED = Instance.new("NumberValue", ITEM_PART)
			CONV_SPEED.Name = "ConvVelo"
			CONV_SPEED.Value = ITEM_INFO.ConveyorSpeed
		elseif ITEM_PART:IsA("Script") then
			ITEM_PART.Disabled = true
		end

		if E%50 == 0 then
			wait()
		end
	end

	ITEM.PrimaryPart = ITEM.Hitbox
	ITEM.PrimaryPart.Transparency = 1
	ITEM.PrimaryPart.Color = Color3.fromRGB(0, 0, 0)
	ITEM.PrimaryPart.Material = Enum.Material.Neon

	if I%175 == 0 then
		wait()
	end
end

-- Function to apply conveyor upgrades to a newly placed item
function ApplyConveyorUpgradesToItem(player, item)
	-- Get the player's conveyor upgrade level
	local upgradeLevel = ConveyorUpgradeApplier.GetPlayerUpgradeLevel(player)

	if upgradeLevel == 0 then
		return -- No upgrade, skip
	end

	local conveyorsUpdated = 0

	-- Apply upgrade to all conveyor parts in this item
	for _, descendant in pairs(item:GetDescendants()) do
		if descendant:IsA("BasePart") then
			if ConveyorUpgradeApplier.ApplyToConveyorPart(descendant, upgradeLevel) then
				conveyorsUpdated = conveyorsUpdated + 1
			end
		end
	end

	if conveyorsUpdated > 0 then
		print("Applied conveyor upgrades to", conveyorsUpdated, "parts in", item.Name, "for", player.Name, "- New speed: base + " .. upgradeLevel)
	end
end

-- Expose function globally so PLACE_ITEM can use it
_G.ApplyConveyorUpgradesToItem = ApplyConveyorUpgradesToItem

print("Item Handler loaded successfully!")
