-- ServerScriptService/ItemHandler.lua
-- COMPLETE VERSION with Conveyor and Miner Upgrade Support

-- Services
local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- Move Items folder if needed
if workspace:FindFirstChild("Items") then
	workspace.Items.Parent = RepStorage
end

-- Load upgrade appliers
local ConveyorUpgradeApplier = require(ServerStorage:WaitForChild("Modules"):WaitForChild("ConveyorUpgradeApplier"))
local MinerUpgradeApplier = require(ServerStorage:WaitForChild("Modules"):WaitForChild("MinerUpgradeApplier"))

-- Process all items in ReplicatedStorage
for I, ITEM in pairs(RepStorage.Items:GetChildren()) do
	local ITEM_INFO = require(ITEM.ItemStats)

	for E, ITEM_PART in pairs(ITEM:GetDescendants()) do
		-- Add ConvVelo to all conveyor types (Conv, ConvMerge, ConvSlope, ConvSlopeMerge)
		if (ITEM_PART.Name == "Conv" or ITEM_PART.Name == "ConvMerge" or ITEM_PART.Name == "ConvSlope" or ITEM_PART.Name == "ConvSlopeMerge") and ITEM_PART:IsA("BasePart") then
			local CONV_SPEED = Instance.new("NumberValue", ITEM_PART)
			CONV_SPEED.Name = "ConvVelo"
			CONV_SPEED.Value = ITEM_INFO.ConveyorSpeed
		elseif ITEM_PART:IsA("Script") then
			ITEM_PART.Disabled = true
		end

		if E%50 == 0 then
			wait()
		end
	end

	ITEM.PrimaryPart = ITEM.Hitbox
	ITEM.PrimaryPart.Transparency = 1
	ITEM.PrimaryPart.Color = Color3.fromRGB(0, 0, 0)
	ITEM.PrimaryPart.Material = Enum.Material.Neon

	if I%175 == 0 then
		wait()
	end
end

-- =====================================================
-- CONVEYOR UPGRADE FUNCTIONS
-- =====================================================

-- Function to apply conveyor upgrades to a newly placed item
function ApplyConveyorUpgradesToItem(player, item)
	-- Get the player's conveyor upgrade level
	local upgradeLevel = ConveyorUpgradeApplier.GetPlayerUpgradeLevel(player)

	if upgradeLevel == 0 then
		return -- No upgrade, skip
	end

	local conveyorsUpdated = 0

	-- Apply upgrade to all conveyor parts in this item
	for _, descendant in pairs(item:GetDescendants()) do
		if descendant:IsA("BasePart") then
			if ConveyorUpgradeApplier.ApplyToConveyorPart(descendant, upgradeLevel) then
				conveyorsUpdated = conveyorsUpdated + 1
			end
		end
	end

	if conveyorsUpdated > 0 then
		print("Applied conveyor upgrades to", conveyorsUpdated, "parts in", item.Name, "for", player.Name, "- New speed: base + " .. upgradeLevel)
	end
end

-- Expose function globally so PLACE_ITEM can use it
_G.ApplyConveyorUpgradesToItem = ApplyConveyorUpgradesToItem

-- =====================================================
-- MINER UPGRADE FUNCTIONS
-- =====================================================

-- Function to apply miner speed upgrades to a newly placed item
function ApplyMinerUpgradesToItem(player, item)
	-- Check if this is a miner that should receive upgrades
	local itemName = item.Name

	-- Determine mine type (remove trailing numbers)
	local baseName = itemName:gsub("%s*%d+$", "")
	local isMiner = baseName:find("Iron Mine") or baseName:find("Copper Mine") or baseName:find("Gold Mine")

	if not isMiner then
		return -- Not a miner, skip
	end

	-- Apply the appropriate speed upgrade
	local success = MinerUpgradeApplier.ApplyToMiner(item, player)

	if success then
		local upgradeLevel = item:GetAttribute("SpeedUpgradeLevel") or 0
		if upgradeLevel > 0 then
			print("Applied speed upgrade level", upgradeLevel, "to", itemName, "for", player.Name)
		end
	end
end

-- Expose function globally so PLACE_ITEM can use it
_G.ApplyMinerUpgradesToItem = ApplyMinerUpgradesToItem

-- =====================================================
-- SCRIPT COMPLETE
-- =====================================================

print("Item Handler loaded successfully!")
print("- Conveyor upgrades ready")
print("- Miner speed upgrades ready")
