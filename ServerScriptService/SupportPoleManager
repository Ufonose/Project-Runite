local RepStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

print("=== SUPPORT POLE MANAGER LOADED ===")

-- Cache of checked poles (now stores visibility state)
local poleStates = {} -- {[pole] = {hidden = true/false, lastCheck = tick()}}

-- Debounce to prevent spam checking
local checkCooldown = {}

-- Function to check if a support pole should be hidden
local function checkSupportPole(supportPole, plot)
	local placedItems = plot:FindFirstChild("PlacedItems")
	if not placedItems then return end

	local shouldHide = false

	-- Check against all SupportCollision parts in the plot
	for _, item in pairs(placedItems:GetChildren()) do
		for _, collision in pairs(item:GetDescendants()) do
			if collision:IsA("BasePart") and collision.Name == "SupportCollision" then

				-- Transform to local space (accounts for rotation)
				local localPos = collision.CFrame:PointToObjectSpace(supportPole.Position)
				local halfSize = collision.Size / 2

				-- Check collision with small tolerance
				if math.abs(localPos.X) <= halfSize.X + 0.5 and 
					math.abs(localPos.Y) <= halfSize.Y + 1 and 
					math.abs(localPos.Z) <= halfSize.Z + 0.5 then
					-- Should hide this pole
					shouldHide = true
					break
				end
			end
		end

		if shouldHide then break end
	end

	-- Update pole visibility
	if shouldHide then
		supportPole.Transparency = 1
		poleStates[supportPole] = {hidden = true, lastCheck = tick()}
	else
		supportPole.Transparency = 0  -- Show the pole if no collision
		poleStates[supportPole] = {hidden = false, lastCheck = tick()}
	end
end

-- Function to check all support poles in a plot (with debounce)
local function checkPlotSupports(plot, forceRecheck)
	if not plot then return end

	-- Debounce - don't check same plot too frequently (unless forced)
	if not forceRecheck and checkCooldown[plot] then
		return
	end
	checkCooldown[plot] = true

	task.delay(0.5, function()
		checkCooldown[plot] = nil
	end)

	local placedItems = plot:FindFirstChild("PlacedItems")
	if not placedItems then return end

	print("Checking support poles in plot...")

	-- Find all support poles in the plot
	local poleCount = 0
	for _, item in pairs(placedItems:GetChildren()) do
		for _, descendant in pairs(item:GetDescendants()) do
			if descendant:IsA("BasePart") and descendant.Name == "SupportPole" then
				poleCount = poleCount + 1
				checkSupportPole(descendant, plot)
			end
		end
	end

	print("Checked", poleCount, "support poles")
end

-- Function to clean up removed poles from cache
local function cleanupPoleCache(item)
	-- Remove all poles from this item from cache
	for _, descendant in pairs(item:GetDescendants()) do
		if descendant:IsA("BasePart") and descendant.Name == "SupportPole" then
			poleStates[descendant] = nil
		end
	end
end

-- Monitor when new items are placed OR removed
local function monitorPlot(plot)
	local placedItems = plot:FindFirstChild("PlacedItems")
	if not placedItems then return end

	-- Check existing items when player joins
	task.wait(2) -- Wait for everything to load
	checkPlotSupports(plot, true)

	-- Monitor for new items being added
	placedItems.ChildAdded:Connect(function(child)
		print("Item added:", child.Name)
		task.wait(1) -- Wait for item to fully load

		-- Check if this new item has SupportCollision (ground conveyor)
		-- If so, we need to recheck ALL poles, not just in this item
		local hasSupportCollision = child:FindFirstChild("SupportCollision", true) ~= nil

		if hasSupportCollision then
			print("Ground conveyor placed - rechecking all poles")
			checkPlotSupports(plot, true) -- Force recheck
		else
			-- Just check poles in the newly placed item
			task.wait(0.5)
			for _, descendant in pairs(child:GetDescendants()) do
				if descendant:IsA("BasePart") and descendant.Name == "SupportPole" then
					checkSupportPole(descendant, plot)
				end
			end
		end
	end)

	-- Monitor for items being removed (NEW!)
	placedItems.ChildRemoved:Connect(function(child)
		print("Item removed:", child.Name)

		-- Clean up cache for this item's poles
		cleanupPoleCache(child)

		-- Check if removed item had SupportCollision
		local hadSupportCollision = child:FindFirstChild("SupportCollision", true) ~= nil

		if hadSupportCollision then
			print("Ground conveyor removed - rechecking all poles")
			-- A ground conveyor was removed, so poles might need to reappear
			task.wait(0.1)
			checkPlotSupports(plot, true) -- Force recheck all poles
		end
	end)
end

-- Setup for each player's plot
Players.PlayerAdded:Connect(function(player)
	-- Wait for plot to be assigned
	local setPlot = player:WaitForChild("SetPlot", 30)
	if not setPlot then return end

	local plot = setPlot.Value
	if plot then
		print("Monitoring plot for:", player.Name)
		monitorPlot(plot)
	end

	-- Monitor if plot changes
	setPlot.Changed:Connect(function()
		if setPlot.Value then
			monitorPlot(setPlot.Value)
		end
	end)
end)

-- Setup for players already in game
for _, player in pairs(Players:GetPlayers()) do
	task.spawn(function()
		local setPlot = player:WaitForChild("SetPlot", 30)
		if setPlot and setPlot.Value then
			monitorPlot(setPlot.Value)
		end
	end)
end

print("=== SUPPORT POLE MANAGER READY ===")
