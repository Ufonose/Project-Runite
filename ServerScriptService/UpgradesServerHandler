-- ServerScriptService/UpgradesServerHandler.lua
-- FIXED: Uses upgrade levels instead of multipliers for conveyor speed

local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- Wait for required folders
local EventsFolder = RepStorage:WaitForChild("Events", 10)
if not EventsFolder then
	warn("Events folder not found in ReplicatedStorage!")
	return
end

-- Load modules
local UpgradesData = require(RepStorage:WaitForChild("Modules"):WaitForChild("UpgradesData"))
local ConveyorUpgradeApplier = require(ServerStorage:WaitForChild("Modules"):WaitForChild("ConveyorUpgradeApplier"))

-- Helper to get player upgrades from global data
local function GetPlayerUpgrades(player)
	if not _G["global_data"] or not _G["global_data"][player.Name] then
		warn("Player data not loaded for", player.Name)
		return {}
	end

	if not _G["global_data"][player.Name]["Upgrades"] then
		_G["global_data"][player.Name]["Upgrades"] = {}
	end

	return _G["global_data"][player.Name]["Upgrades"]
end

-- Get all player upgrades
local GetPlayerUpgradesRemote = EventsFolder:FindFirstChild("GetPlayerUpgrades")
if GetPlayerUpgradesRemote then
	GetPlayerUpgradesRemote.OnServerInvoke = function(player)
		local upgrades = GetPlayerUpgrades(player)

		-- Ensure all upgrade types exist with default level 0
		for upgradeId, _ in pairs(UpgradesData.Upgrades) do
			if not upgrades[upgradeId] then
				upgrades[upgradeId] = 0
			end
		end

		return upgrades
	end
else
	warn("GetPlayerUpgrades RemoteFunction not found!")
end

-- Get upgrades data
local GetUpgradesDataRemote = EventsFolder:FindFirstChild("GetUpgradesData")
if GetUpgradesDataRemote then
	GetUpgradesDataRemote.OnServerInvoke = function(player)
		-- Convert upgrades data to be client-safe (no functions)
		local clientSafeData = {}

		for upgradeId, upgradeData in pairs(UpgradesData.Upgrades) do
			clientSafeData[upgradeId] = {
				Name = upgradeData.Name,
				Description = upgradeData.Description,
				Icon = upgradeData.Icon,
				BaseCost = upgradeData.BaseCost,
				CostMultiplier = upgradeData.CostMultiplier,
				MaxLevel = upgradeData.MaxLevel,
				SortOrder = upgradeData.SortOrder,
			}
		end

		return clientSafeData
	end
else
	warn("GetUpgradesData RemoteFunction not found!")
end

-- Buy upgrade
local BuyUpgradeRemote = EventsFolder:FindFirstChild("BuyUpgrade")
if BuyUpgradeRemote then
	BuyUpgradeRemote.OnServerInvoke = function(player, upgradeId)
		-- Validate upgrade exists
		local upgradeData = UpgradesData.Upgrades[upgradeId]
		if not upgradeData then
			warn("Invalid upgrade ID:", upgradeId)
			return false
		end

		-- Get current upgrades
		local upgrades = GetPlayerUpgrades(player)

		-- Get current level
		local currentLevel = upgrades[upgradeId] or 0

		-- Check if already at max level
		if UpgradesData.IsMaxLevel(upgradeId, currentLevel) then
			warn("Upgrade already at max level")
			return false
		end

		-- Calculate cost
		local cost = UpgradesData.GetUpgradeCost(upgradeId, currentLevel)

		-- Get player's cash
		local cashValue = ServerStorage.ServerLockedPlayerInfo.PlayerCash:FindFirstChild(player.Name)
		if not cashValue then
			warn("Player cash not found!")
			return false
		end

		local currentCash = cashValue.Value

		-- Check if player can afford it
		if currentCash < cost then
			warn("Not enough cash. Need:", cost, "Have:", currentCash)
			return false
		end

		-- Deduct cash
		cashValue.Value = cashValue.Value - cost

		-- Increment upgrade level
		local newLevel = currentLevel + 1
		upgrades[upgradeId] = newLevel

		print(player.Name, "upgraded", upgradeData.Name, "to level", newLevel)

		-- APPLY UPGRADE TO EXISTING ITEMS
		if upgradeId == "ConveyorSpeed" then
			-- Apply the upgrade level (+1 speed per level) to all conveyors
			local conveyorsUpdated = ConveyorUpgradeApplier.ApplyToPlayerPlot(player, newLevel)

			print("Updated", conveyorsUpdated, "conveyors for", player.Name, "- New speed: base + " .. newLevel)
		end

		return true
	end
else
	warn("BuyUpgrade RemoteFunction not found!")
end

-- Helper function to get upgrade multiplier (used by other systems)
function GetUpgradeMultiplier(player, upgradeId)
	local upgrades = GetPlayerUpgrades(player)
	local level = upgrades[upgradeId] or 0
	return UpgradesData.GetUpgradeMultiplier(upgradeId, level)
end

-- Expose function globally for other scripts to use
_G.GetUpgradeMultiplier = GetUpgradeMultiplier

print("Upgrades server handler loaded successfully!")
