-- ========================================
-- NEW SCRIPT: ServerScriptService/ConveyorSpeedRefresher
-- Create this as a new Script in ServerScriptService
-- ========================================

local RepStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- Function to refresh all conveyor speeds for a player
local function RefreshPlayerConveyorSpeeds(player)
	-- Find the player's plot
	local plot = workspace.Plots:FindFirstChild(player.Name)
	if not plot then
		warn("Plot not found for player:", player.Name)
		return
	end

	-- Get the player's conveyor speed upgrade
	local speedBonus = 0
	if _G.GetUpgradeMultiplier then
		speedBonus = _G.GetUpgradeMultiplier(player, "ConveyorSpeed")
	end

	print("Refreshing conveyors for", player.Name, "with speed bonus:", speedBonus)

	-- Find all placed items in the plot
	local placedItems = plot:FindFirstChild("PlacedItems")
	if not placedItems then
		warn("PlacedItems not found in plot")
		return
	end

	local updatedCount = 0

	-- Loop through all items in the plot
	for _, item in pairs(placedItems:GetChildren()) do
		-- Find the ItemStats to get base speed
		local itemStats = item:FindFirstChild("ItemStats")
		if itemStats then
			local itemInfo = require(itemStats)

			-- Only update if this item has ConveyorSpeed
			if itemInfo.ConveyorSpeed and itemInfo.ConveyorSpeed > 0 then
				local baseSpeed = itemInfo.ConveyorSpeed

				-- Update all Conv, ConvMerge, and ConvSlope parts
				for _, descendant in pairs(item:GetDescendants()) do
					if descendant:IsA("BasePart") and (descendant.Name == "Conv" or descendant.Name == "ConvMerge" or descendant.Name == "ConvSlope") then
						local convVelo = descendant:FindFirstChild("ConvVelo")
						if convVelo then
							-- Check if this conveyor is reversed
							local isReversed = convVelo.Value < 0

							-- Calculate new speed (base + bonus)
							local newSpeed = baseSpeed + speedBonus

							-- Apply with correct direction
							convVelo.Value = isReversed and -newSpeed or newSpeed

							updatedCount = updatedCount + 1
							print("Updated conveyor:", item.Name, descendant.Name, "Speed:", convVelo.Value)
						end
					end
				end
			end
		end
	end

	print("Updated", updatedCount, "conveyors for", player.Name)
end

-- Listen for upgrade purchases (when player buys ConveyorSpeed upgrade)
-- We'll use a RemoteEvent to trigger this
local refreshEvent = RepStorage.Events:FindFirstChild("RefreshConveyorSpeeds")
if not refreshEvent then
	refreshEvent = Instance.new("RemoteEvent")
	refreshEvent.Name = "RefreshConveyorSpeeds"
	refreshEvent.Parent = RepStorage.Events
end

refreshEvent.OnServerEvent:Connect(function(player)
	RefreshPlayerConveyorSpeeds(player)
end)

-- Also refresh when a player's data loads (wait for DataLoaded tag)
Players.PlayerAdded:Connect(function(player)
	-- Wait for DataLoaded tag
	local dataLoaded = player:WaitForChild("DataLoaded", 30)

	if dataLoaded then
		-- Wait a moment for plot items to fully load
		task.wait(1)

		-- Check if player still exists
		if Players:FindFirstChild(player.Name) then
			RefreshPlayerConveyorSpeeds(player)
		end
	end
end)

print("Conveyor Speed Refresher loaded!")
