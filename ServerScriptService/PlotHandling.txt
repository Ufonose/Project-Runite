-- ServerScriptService/PlotHandling.txt (SIMPLIFIED - NO HEIGHT CHECK)

-- Services
local RepStorage = game:GetService("ReplicatedStorage")
local Plrs = game:GetService("Players")
-- Modules
local Enums = require(RepStorage.Modules.CustomEnums)
local MainLib = require(RepStorage.Modules.MainLib)

for I, PLOT in pairs(workspace.Plots:GetChildren()) do
	PLOT.Owner.Value = "Empty Plot"
	for I, MISC_FOLDER_NAME in pairs(Enums.Arrays.MISC_PLOT_FOLDERS) do
		local FOLDER = Instance.new("Folder", PLOT.MiscInfo)
		FOLDER.Name = MISC_FOLDER_NAME
	end

	-- ULTRA SIMPLE: If an ore touches the BasePlot directly, destroy it
	-- Ores on conveyors won't touch the BasePlot because the conveyor is in between
	PLOT.BasePlot.Touched:Connect(function(HIT)
		-- Check if HIT is part of an ore (has Cash)
		local ORE_TO_DESTROY = nil

		-- Check if HIT itself has Cash (single-part ore)
		if HIT:FindFirstChild("Cash") then
			ORE_TO_DESTROY = HIT
			-- Check if HIT's parent is a Model with Cash (model ore)
		elseif HIT.Parent and HIT.Parent:IsA("Model") and HIT.Parent:FindFirstChild("Cash") then
			ORE_TO_DESTROY = HIT.Parent
		end

		-- If we found an ore, destroy it
		if ORE_TO_DESTROY then
			ORE_TO_DESTROY:Destroy()
		end
	end)
end

local function SPAWN_PLAYER(Plr)
	Plr.Character:WaitForChild("HumanoidRootPart")
	local REAL_PLOT = Plr.SetPlot.Value
	for I=1, 5 do
		Plr.Character:WaitForChild("HumanoidRootPart")
		Plr.Character.HumanoidRootPart.CFrame = CFrame.new(REAL_PLOT.BasePlot.Position+Vector3.new(0, Enums.Nums.SPAWN_REG_HEIGHT, 0))
		wait()
	end
end

local function PLR_ADDED(Plr)
	local PLOT_INFO = Instance.new("ObjectValue", Plr)
	PLOT_INFO.Name = "SetPlot"
	PLOT_INFO.Value = MainLib.SET_PLOT(Plr)
	-- Plot Setup
	PLOT_INFO.Value.Owner.Value = Plr.Name
	-- Player Spawning
	Plr.CharacterAdded:Connect(function()
		SPAWN_PLAYER(Plr)
	end)
end
Plrs.PlayerAdded:Connect(PLR_ADDED)
