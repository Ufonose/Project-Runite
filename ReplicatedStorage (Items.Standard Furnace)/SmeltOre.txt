local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local ITEM_HANDLER = require(RepStorage.Modules.ItemHandler)
local ITEM_INFO = require(script.Parent.Parent.ItemStats)
local PLOT = script.Parent.Parent.Parent.Parent

-- Check if running on server
local isServer = game:GetService("RunService"):IsServer()

script.Parent.Smelt.Touched:Connect(function(HIT)
	local ORE = nil

	-- Check if the hit part itself has Cash (old system - single part)
	if HIT:FindFirstChild("Cash") then
		ORE = HIT
	else
		-- Check if the hit part's parent is a model with Cash (new system - model)
		if HIT.Parent and HIT.Parent:IsA("Model") and HIT.Parent:FindFirstChild("Cash") then
			ORE = HIT.Parent
		end
	end

	-- Process the ore if we found one
	if ORE and ORE:FindFirstChild("Cash") then
		if ORE.Cash.Value >= 0 then
			local Plrs = game:GetService("Players")
			local plot_owner = Plrs:FindFirstChild(PLOT.Owner.Value)

			if plot_owner and isServer then
				-- ALWAYS process for cash first
				local PROCESSED = ITEM_HANDLER.PROCESS_ORE(PLOT, script.Parent.Parent, script.Parent.Smelt, ITEM_INFO.Addition, ITEM_INFO.Multiplier, ORE)

				if PROCESSED then
					-- ALSO try to deposit to research (if any active objectives need this item)
					local ResearchHandler = require(ServerStorage.Modules.ResearchHandler)
					local ResearchData = require(ServerStorage.Modules.ResearchData)

					-- Get the ore model name from tag or fallback to Name
					local oreModelName = nil
					local oreModelTag = ORE:FindFirstChild("OreModelName")

					if oreModelTag then
						oreModelName = oreModelTag.Value
					else
						oreModelName = ORE.Name
					end

					-- Try to deposit to any active objective that needs this item
					local research = ResearchHandler.GetPlayerResearch(plot_owner)
					local deposited = false

					for _, objectiveId in pairs(research.ActiveObjectives) do
						local success, currentProgress = ResearchHandler.DepositItem(plot_owner, objectiveId, oreModelName, 1)

						if success then
							deposited = true

							-- Get the objective to find the required amount
							local objective = ResearchData.GetObjective(objectiveId)
							local requiredAmount = 0

							-- Find the requirement for this specific item
							if objective then
								for _, requirement in pairs(objective.Requirements) do
									if requirement.ItemName == oreModelName then
										requiredAmount = requirement.Amount
										break
									end
								end
							end

							-- Only show message if this specific requirement isn't already complete
							if currentProgress < requiredAmount then
								-- Show research progress message WITHOUT emoji, with current/required format
								local displayName = oreModelName:gsub("OreModel", ""):gsub("_", " ")
								RepStorage.Events.MessageClient:FireClient(plot_owner, "visual", {
									["visual_part"] = script.Parent.Smelt, 
									["message"] = displayName .. " (" .. currentProgress .. "/" .. requiredAmount .. ")", 
									["message_color"] = Color3.fromRGB(138, 180, 255)
								})
							end
							-- No break - continues to check other objectives!
						end
					end

					-- Destroy ore after processing
					ORE:Destroy()
				end
			else
				-- Default behavior if no plot owner
				local PROCESSED = ITEM_HANDLER.PROCESS_ORE(PLOT, script.Parent.Parent, script.Parent.Smelt, ITEM_INFO.Addition, ITEM_INFO.Multiplier, ORE)
				if PROCESSED then
					ORE:Destroy()
				end
			end
		end
	end
end)
