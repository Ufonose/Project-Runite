-- ReplicatedStorage (Items.Standard Furnace)/SmeltOre.txt (TRACKS ALL ITEMS)

local RepStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local ITEM_HANDLER = require(RepStorage.Modules.ItemHandler)
local ITEM_INFO = require(script.Parent.Parent.ItemStats)
local PLOT = script.Parent.Parent.Parent.Parent

-- Check if running on server
local isServer = game:GetService("RunService"):IsServer()

script.Parent.Smelt.Touched:Connect(function(HIT)
	local ORE = nil

	-- Check if the hit part itself has Cash (old system - single part)
	if HIT:FindFirstChild("Cash") then
		ORE = HIT
	else
		-- Check if the hit part's parent is a model with Cash (new system - model)
		if HIT.Parent and HIT.Parent:IsA("Model") and HIT.Parent:FindFirstChild("Cash") then
			ORE = HIT.Parent
		end
	end

	-- Process the ore if we found one
	if ORE and ORE:FindFirstChild("Cash") then
		if ORE.Cash.Value >= 0 then
			local Plrs = game:GetService("Players")
			local plot_owner = Plrs:FindFirstChild(PLOT.Owner.Value)

			if plot_owner and isServer then
				-- ALWAYS process for cash first
				local PROCESSED = ITEM_HANDLER.PROCESS_ORE(PLOT, script.Parent.Parent, script.Parent.Smelt, ITEM_INFO.Addition, ITEM_INFO.Multiplier, ORE)

				if PROCESSED then
					local ResearchHandler = require(ServerStorage.Modules.ResearchHandler)
					local ResearchData = require(ServerStorage.Modules.ResearchData)

					-- Get the ore model name from tag or fallback to Name
					local oreModelName = nil
					local oreModelTag = ORE:FindFirstChild("OreModelName")

					if oreModelTag then
						oreModelName = oreModelTag.Value
					else
						oreModelName = ORE.Name
					end

					-- NEW: ALWAYS track item collection for statistics (before research deposit)
					ResearchHandler.TrackItemCollection(plot_owner, oreModelName, 1)

					-- THEN try to deposit to research (if any active objectives need this item)
					local research = ResearchHandler.GetPlayerResearch(plot_owner)
					local deposited = false

					for _, objectiveId in pairs(research.ActiveObjectives) do
						-- Get the objective first to check requirement amount
						local objective = ResearchData.GetObjective(objectiveId)
						if objective then
							for _, req in pairs(objective.Requirements) do
								if req.ItemName == oreModelName then
									-- Check current progress
									local currentProgress = research.ObjectiveProgress[tostring(objectiveId)][oreModelName] or 0

									-- Only deposit if not already complete
									if currentProgress < req.Amount then
										local success, newProgress = ResearchHandler.DepositItem(plot_owner, objectiveId, oreModelName, 1)

										if success then
											deposited = true

											-- Show visual feedback for research deposit
											local progressMsg = string.format("%s: %d/%d", 
												req.ItemName:gsub("OreModel", ""):gsub("_", " "), 
												newProgress, 
												req.Amount
											)

											RepStorage.Events.MessageClient:FireClient(
												plot_owner, 
												"visual", 
												{
													["visual_part"] = script.Parent.Smelt, 
													["message"] = progressMsg, 
													["message_color"] = Color3.fromRGB(134, 207, 255)
												}
											)

											break
										end
									end
									break  -- Found the requirement, stop checking other requirements
								end
							end

							if deposited then
								break  -- Already deposited to this objective, stop checking other objectives
							end
						end
					end
				end

				-- Destroy ore
				ORE:Destroy()
			end
		end
	end
end)
